# üß† LDAP & Active Directory Pentesting Checklist & Commands (OSCP Optimized)

---

## üéØ What am I realistically expecting to find?

‚≠ê After enumerating LDAP (port **389** / **636**), I expect to discover:

- [ ] List of domain **users and groups** (sAMAccountName, displayName, description)
- [ ] **Domain structure** (OU, CN, DC)
- [ ] Misconfigured **permissions or delegation**
- [ ] Accounts with **PasswordNotRequired**, blank passwords, or weak policies
- [ ] **ASREPRoastable / Kerberoastable** accounts
- [ ] **GMSA** (Group Managed Service Accounts)
- [ ] SID History & **ACLs** for lateral movement
- [ ] **Privileged group memberships** (Domain Admins, Backup Operators)
- [ ] Password spray/brute-force possibilities
- [ ] Potential **targets for relaying or escalation**

---

## ‚úÖ Active Directory Basics (Short Summary)

- **AD Structure:** Forest ‚Üí Domains ‚Üí OUs ‚Üí Objects (users, computers, groups)
- **Objects:** Contain attributes stored in the AD database (NTDS.dit)
- **Common Attributes:** `sAMAccountName`, `memberOf`, `description`, `userAccountControl`
- **AD Default Ports:** LDAP (389), LDAPS (636), Kerberos (88), SMB (445)
- **Important Groups:** `Domain Admins`, `Enterprise Admins`, `Backup Operators`, `DnsAdmins`
- **Enumeration Goal:** Identify misconfigurations, privileged accounts, and escalation paths

---

## ‚úÖ LDAP Anonymous Enumeration (Without Credentials)

- [ ] **Check for Anonymous Bind**
    ```bash
    ldapsearch -x -H ldap://<IP> -s base "(objectclass=*)"
    ldapsearch -x -H ldap://<IP> -s base namingcontexts
    ```

- [ ] **Full Dump (If Allowed)**
    ```bash
    ldapsearch -x -H ldap://<IP> -b "DC=domain,DC=local" "(objectClass=*)"
    ldapsearch -x -H ldap://<IP> -b "DC=domain,DC=local" "(&(objectclass=user))" | grep sAMAccountName
    ldapsearch -x -H ldap://<IP> -b "DC=domain,DC=local" "(&(objectclass=group))"
    ```

- [ ] **Extract Users**
    ```bash
    ldapsearch -h <IP> -x -b "DC=domain,DC=local" -s sub "(&(objectclass=user))" | grep sAMAccountName | cut -f2 -d" "
    ```

- [ ] **Anonymous windapsearch**
    ```bash
    python3 windapsearch.py --dc-ip <IP> -u "" -U
    python3 windapsearch.py --dc-ip <IP> -u "" -C
    python3 windapsearch.py --dc-ip <IP> -u "" -G
    python3 windapsearch.py --dc-ip <IP> -u "" --functionality
    ```

- [ ] **Nmap Enumeration**
    ```bash
    nmap -n -sV --script "ldap* and not brute" <IP>
    ```

---

## ‚úÖ LDAP Enumeration (With Credentials)

- [ ] **windapsearch Basic Enumeration**
    ```bash
    python3 windapsearch.py --dc-ip <IP> -u 'domain\\user' -p 'password' --da
    python3 windapsearch.py --dc-ip <IP> -u 'domain\\user' -p 'password' -U
    python3 windapsearch.py --dc-ip <IP> -u 'domain\\user' -p 'password' -G
    python3 windapsearch.py --dc-ip <IP> -u 'domain\\user' -p 'password' -C
    ```

- [ ] **Delegation & Exposure**
    ```bash
    python3 windapsearch.py --dc-ip <IP> -u 'domain\\user' -p 'password' --delegation
    python3 windapsearch.py --dc-ip <IP> -u 'domain\\user' -p 'password' --unconstrained-users
    python3 windapsearch.py --dc-ip <IP> -u 'domain\\user' -p 'password' --trusted-for-delegation
    python3 windapsearch.py --dc-ip <IP> -u 'domain\\user' -p 'password' --password-not-required
    python3 windapsearch.py --dc-ip <IP> -u 'domain\\user' -p 'password' --admin-count
    python3 windapsearch.py --dc-ip <IP> -u 'domain\\user' -p 'password' --gmsa
    ```

- [ ] **Trusts and Group Memberships**
    ```bash
    python3 windapsearch.py --dc-ip <IP> -u 'domain\\user' -p 'password' --group-memberships
    python3 windapsearch.py --dc-ip <IP> -u 'domain\\user' -p 'password' --trusts
    ```

- [ ] **LDAPDomainDump**
    ```bash
    ldapdomaindump ldap://<IP> -u 'domain\\user' -p 'password' -o /tmp/ldapdump
    ```

- [ ] **CME / NetExec LDAP**
    ```bash
    nxc ldap <IP> -u user -p password --users --groups --trusted-for-delegation --password-not-required --admin-count
    cme ldap <IP> -u user -p password -M laps
    ```

---
## ‚úÖ PowerShell & RSAT Enumeration (Living off the Land)

- [ ] **Check Installed RSAT Modules**
    ```powershell
    Get-WindowsCapability -Name RSAT* -Online
    ```

- [ ] **Install RSAT AD Tools**
    ```powershell
    Add-WindowsCapability -Name Rsat.ActiveDirectory.DS-LDS.Tools~~~~0.0.1.0 ‚ÄìOnline
    ```

- [ ] **AD Queries**
    ```powershell
    Get-ADUser -Filter *
    Get-ADGroup -Filter "adminCount -eq 1"
    Get-ADComputer -Filter "DNSHostName -like 'SQL*'"
    ```

- [ ] **Context Switching**
    ```powershell
    runas /netonly /user:domain\\user powershell
    ```

---

## ‚úÖ LDAP Filters & Advanced Queries

### üîπ Common Filters
```text
(userAccountControl:1.2.840.113556.1.4.803:=524288)   # Trusted for Delegation
(userAccountControl:1.2.840.113556.1.4.803:=4194304)  # ASREPRoastable
(userAccountControl:1.2.840.113556.1.4.803:=32)       # Password Not Required
(userAccountControl:1.2.840.113556.1.4.803:=65536)    # Password Never Expires
(userAccountControl:1.2.840.113556.1.4.803:=2)        # Disabled Accounts
```

### üîπ Recursive Group Membership (OID)
```c
Get-ADGroup -LDAPFilter '(member:1.2.840.113556.1.4.1941:=CN=Bob,OU=Users,DC=domain,DC=local)'
```
### üîπ SearchBase & SearchScope
```c
# Base = 0 (object only), OneLevel = 1 (OU only), Subtree = 2 (recursive)
Get-ADUser -SearchBase "OU=Employees,DC=domain,DC=local" -SearchScope Subtree -Filter *
```

### ‚úÖ SYSTEM-Level Enumeration

- SYSTEM can enumerate LDAP using the machine account
- Achieve SYSTEM via:
    - Service Exploits
    - SeImpersonate (PrintSpoofer, JuicyPotato)
    - PsExec with `-s`

### ‚úÖ Automation with Python (ldap3)
```c
from ldap3 import *
s = Server('10.10.10.10', get_info=ALL)
c = Connection(s, '', '')
c.bind()
print(s.info)
```
### ‚úÖ NTLM Relay + Computer Add
```c
python3 ntlmrelayx.py -t ldap://<IP> --delegate-access
python3 addcomputer.py -method LDAPS -dc-ip <IP> -computer-name WINDELL -computer-pass 'W1nd@ll!' domain.local/user:password
```
### ‚úÖ BloodHound Enumeration
```c
bloodhound-python -u user -p password -d domain.local -c All --zip -dc <IP>
Invoke-BloodHound -CollectionMethod All -ZipFileName loot.zip
```
