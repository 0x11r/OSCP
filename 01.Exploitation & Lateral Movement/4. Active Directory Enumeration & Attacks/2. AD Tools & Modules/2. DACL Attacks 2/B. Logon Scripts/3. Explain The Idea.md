
---
---
In Active Directory environments, system administrators use `logon scripts` to automate various user tasks or configurations when logging into the domain, such as mapping and unmapping network drives, auditing and reporting, gathering information, and environment customization. There are two methods for assigning users a `logon script`: the first is by using the `Logon script` field in the `Profile` tab of the user properties dialog, which internally updates the `scriptPath` attribute, while the second is by utilizing a `Group Policy`.

## The scriptPath Attribute

Defined in [MS-ADA3](https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-ada3/c640630e-23ff-44e7-886f-16df9574039e), the [scriptPath](https://learn.microsoft.com/en-us/windows/win32/adschema/a-scriptpath) attribute (part of the [User-Logon property set](https://learn.microsoft.com/en-us/windows/win32/adschema/r-user-logon)) specifies the path for a user's `logon script`; when setting it via the `Logon script` field in the `Profile` tab of a user's properties dialog in `ADUC`, AD updates `scriptPath` accordingly:

![Logon_Script_Image_1](https://academy.hackthebox.com/storage/modules/255/Logon_Script_Image_1.png)

`scriptPath` supports batch (*.bat) or command (*.cmd) files, executable programs (*.exe), or programs written in any language hosted by the [Windows Script Host automation technology](https://www.rlmueller.net/LogonScriptFAQ.htm#What%20languages%20can%20I%20use%20for%20logon%20scripts), including [VBScript](https://documentation.help/MS-Office-VBScript/VBStoc.htm) and [JScript](https://documentation.help/MS-Office-JScript/). Additionally, [KiXtart](http://www.kixtart.org/), a logon script processor and enhanced batch scripting language can be used. Regardless of the myriad of languages it supports, `scriptPath` does not support PowerShell; however, we can run PowerShell commands from within batch and VBScript files.

To allow for replication to all domain controllers in the domain, Windows stores `logon scripts` in the `scripts` folder within the `SYSVOL` network share (which, on a domain controller, resides at the physical location `%systemroot%\SYSVOL\sysvol`); `SYSVOL` also stores domain and system policies, including `Group Policy Objects`. For ease of use, the `NETLOGON` network share holds all the logon scripts that reside in the `%systemroot%\SYSVOL\sysvol\<DOMAIN_DNS_NAME>\scripts\` folder, and these two are the same. The `LOGONSERVER` environment variable, which evaluates to the [NetBIOS name](https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-ada3/131ef89f-328f-4e9c-9e33-13f8df183aea) of the domain controller that authenticated the current user, can help us locate the `SYSVOL` and `NETLOGON` network shares.

For Windows to be able to execute them once a user logs into the domain, `Logon scripts` set via the `scriptPath` attribute (which are known as `Legacy logon scripts`) must be placed within the `NETLOGON` share; it is not possible to have them on a different network share, regardless whether they are local or remote ones.

Alternatively, a `logon script` that applies to all domain users can be set in [Group Policy](https://www.rlmueller.net/LogonScriptFAQ.htm#How%20do%20I%20configure%20a%20logon%20script%20with%20Group%20Policy) (which are known as `Modern logon scripts`) using the setting found at `User Configuration` ---> `Windows Settings` ---> `Scripts (Logon/Logoff)` ---> `Logon`:

![Logon_Script_Image_2](https://academy.hackthebox.com/storage/modules/255/Logon_Script_Image_2.png)

In addition to all the languages that `scriptPath` supports, this `Group Policy` setting supports using [PowerShell scripts](https://woshub.com/running-powershell-startup-scripts-using-gpo/) for `logon scripts`:

![Logon_Script_Image_3](https://academy.hackthebox.com/storage/modules/255/Logon_Script_Image_3.png)

### Abusing scriptPath

Throughout engagements, abusing `logon scripts` via rights on a user's `scriptPath` attribute depends on whether we can `write` or `read` it and other factors.

#### Write scriptPath

Possessing the right to `write` a user's `scriptPath` opens avenues for potential attack paths. If we have `write` permissions anywhere within the `NETLOGON` share (both NTFS permissions and share permissions), we can set a user's `scriptPath` to a custom exploit script. This section will focus on exploiting `write` rights over a user's `scriptPath`.

#### Read scriptPath

In cases where we do not have rights to `write` a user's `scriptPath`, having rights to `read` it, which is the default, can still be advantageous: we can inspect the permissions we have on the file `scriptPath` points to (using tools such as `icacls`). Suppose we have `write` permissions on that file. In that case, we can execute the same attacks as if we had `write` rights on `scriptPath` without requiring `write` permissions anywhere within `NETLOGON`; this becomes particularly valuable when a "stub" logon script is employed, where `scriptPath` points to another file containing the actual logon script code, often stored in a network share other than `NETLOGON` (which domain users might have `write` permissions on).

# Scenario

Our client, `inlanefreight`, has provided us the username `david` and the password `SecurePassDav!d5` to determine what DACL attacks the user can perform against the user `eric`.

