
---
---

[Shadow Credentials](https://posts.specterops.io/shadow-credentials-abusing-key-trust-account-mapping-for-takeover-8ee1a53566ab) is an alternative user and computer account takeover technique that abuses Windows Hello for Business functionality for passwordless authentication. It works by adding `Key Credentials` to the `msDS-KeyCredentialLink` attribute of the target user/computer account and then performing Kerberos authentication as that account using PKINIT. This method is much easier and more reliable than primitive techniques such as `Password Reset` or `Roasting` against users and `RBCD` against computers.

## Kerberos Pre-Authentication

In Active Directory domains, the [Kerberos Authentication Process](https://academy.hackthebox.com/module/25/section/137) relies on a preliminary step called `pre-authentication`. The purpose of `pre-authentication` is to prevent offline attacks like [AS-REP Roasting](https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/asreproast), where anyone can obtain an encrypted blob using a client's password-derived key and attempt to crack it. To prove their identity, the client has to encrypt the current timestamp with their key, which derives the client's password (DES, RC4, AES128, or AES256) and sends it to the KDC. If the KDC can decrypt the timestamp, the client is using the correct password-derived key, as the KDC has access to all passwords derived keys in the domain.

When `pre-authentication` is successfully concluded by an authenticating client, a [TGT](https://learn.microsoft.com/en-us/windows/win32/secauthn/ticket-granting-tickets) is supplied, allowing that client to effectively ask for more tickets to connect to other services in the network.

There is, however, a use case where the key derived from the password is not used at all, and the `pre-authentication` scheme is conducted asymmetrically. This scenario is called [Public Key Cryptography for Initial Authentication (PKINIT)](https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-pkca/d0cf1763-3541-4008-a75f-a577fa5e8c5b) and allows a user to obtain a TGT with a [x509 certificate](https://en.wikipedia.org/wiki/X.509) within Active Directory domains configured with a PKI (Public Key Infrastructure). It's worth noting that AD CS (Active Directory Certificate Services) is Microsoft's PKI implementation.

The PKINIT protocol is a security protocol that authenticates entities on a network using public key cryptography. PKINIT is a `pre-authentication` extension that extends the Kerberos Protocol to use public key cryptography and ticket-granting ticket (TGT) data signing during the initial AS exchange. It's specified in [RFC4556], but Microsoft has made some modifications for Windows implementation of PKINIT that differs from [[RFC4556]](https://datatracker.ietf.org/doc/html/rfc4556) which can be found in [[MS-PKCA]: Public Key Cryptography for Initial Authentication (PKINIT) in Kerberos Protocol](https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-pkca/d0cf1763-3541-4008-a75f-a577fa5e8c5b).

## Passwordless authentication

Microsoft introduced the concept of [Key Trust](https://learn.microsoft.com/en-us/windows/security/identity-protection/hello-for-business/deploy/hybrid-key-trust) in Windows Server 2016 to enable passwordless authentication in environments that don't support Certificate Trust. With Key Trust, PKINIT authentication is established using raw key data stored in the AD object's attribute called `msDS-KeyCredentialLink` instead of a certificate.

The client's public key is stored in the multi-value attribute, `msDS-KeyCredentialLink`. This attribute's values are Key Credentials, serialized objects containing information such as the creation date, the distinguished name of the owner, a GUID that represents a Device ID, and, of course, the public key. It is a multi-value attribute because an account has several linked devices.

---
---

>  can use PowerView to query for users with `msDS-KeyCredentialLink` attribute not empty:

```powershell
PS C:\Tools> Get-DomainUser -Filter '(msDS-KeyCredentialLink=*)'

logoncount             : 5
msds-keycredentiallink : B:828:00020000200001A98B9A34A7566C0B8633DF6ADBF934CFE79BE8617097536146F1F062ED29659920000272FF1:CN=Gabriel,
                         CN=Users,DC=lab,DC=local
badpasswordtime        : 1/1/1601 1:00:00 AM
distinguishedname      : CN=Gabriel,CN=Users,DC=lab,DC=local
objectclass            : {top, person, organizationalPerson, user}
displayname            : Gabriel
lastlogontimestamp     : 4/27/2024 6:18:37 PM
userprincipalname      : gabriel@lab.local
name                   : Gabriel
objectsid              : S-1-5-21-2570265163-3918697770-3667495639-4602
samaccountname         : gabriel
```

This attribute contains Key Credentials, which are serialized objects that include information such as the creation date, the distinguished name of the owner, a GUID representing a Device ID, and, of course, the public key itself. Since an account can have multiple linked devices, `msDS-KeyCredentialLink` is a multi-value attribute.

Microsoft passwordless solution is called [Windows Hello for Business (WHfB)](https://learn.microsoft.com/en-us/windows/security/identity-protection/hello-for-business/). With WHfB, when a user enrolls, the [TPM](https://support.microsoft.com/en-us/topic/what-is-tpm-705f241d-025d-4470-80c5-4feeb24fa1ee) generates a public-private key pair for their account. The private key is stored in the TPM and never leaves it. Suppose the organization has implemented the Certificate Trust model. In that case, the client issues a certificate request to obtain a trusted certificate from the environment’s certificate issuing authority for the TPM-generated key pair. On the other hand, if the Key Trust model is implemented, the public key is stored in a new Key Credential object in the `msDS-KeyCredentialLink` attribute of the account. The private key is protected by a PIN code, which can be replaced with a biometric authentication factor like fingerprint or face recognition, thanks to Windows Hello.

Windows attempts to perform PKINIT authentication using their private key when a client logs in. Under the Key Trust model, the Domain Controller can decrypt their pre-authentication data using the raw public key in the corresponding object stored in the client’s `msDS-KeyCredentialLink` attribute.

## Shadow Credential Attack

Shadow Credentials are a way to gain control over an Active Directory user or computer by exploiting the passwordless authentication function used in the Key Trust model. Suppose we have permission to modify the `msDS-KeyCredentialLink` attribute of the target object. In that case, we can add an alternate credential as a certificate to take control of the target.

The tool called [Whisker](https://github.com/eladshamir/Whisker) can be used to take over Active Directory user and computer accounts by manipulating their `msDS-KeyCredentialLink` attribute, effectively adding `Shadow Credentials` to the target account.

Shadow Credential attack is possible when the controlled account has a `GenericAll`, `GenericWrite`, over the target, or `WriteProperty` over the target's `msDS-KeyCredentialLink` attribute. As we mentioned in Passwordless authentication, we can add alternate credentials and request a TGT to authenticate as the target.

## NTLM hash with Shadow Credential Attack

For compatibility purposes, when a client uses PKINIT and needs to communicate with a service that doesn't support Kerberos authentication, NTLM is used. Microsoft introduced a special Service Ticket as an alternative authentication method to address that. This ticket contains the NTLM hash inside the `Privilege Attribute Certificate (PAC)` in an encrypted `NTLM_SUPPLEMENTAL_CREDENTIAL` entity.

The encrypted PAC is stored within the ticket, which is encrypted using the key of the service it was issued for. For a TGT, the ticket is encrypted using the key of the KRBTGT account, which the client cannot decrypt. To obtain a ticket that can be decrypted, the client needs to perform Kerberos User-to-User (U2U) authentication to itself.

Every time a client requests a TGT, a new session key is created. The KDC does not keep a record of active session keys but extracts the session key from the client's ticket. When a user requests a `U2U TGS-REQ`, the KDC uses the target user's TGT as an additional ticket in the response. The KDC then extracts the session key from the encrypted part of the TGT and generates a new service ticket.

The above means that if we request a U2U Service Ticket from ourselves to ourselves, we will be able to decrypt the ticket and access the PAC and the NTLM hash because the key used to encrypt the ticket is in our possession. By modifying the `msDS-KeyCredentialLink` property, we can also obtain a user's or computer's NTLM hash.

---
---

## Pre-requisites

For this technique to work, it is necessary to have the ability to write the attribute `msDS-KeyCredentialLink` on a target user or computer, and the environment must be set up as follows:

1. The target Domain must have at least one Domain Controller running Windows Server 2016 or above.
2. The Domain Functional Level should be Windows Server 2016 or above.
3. The Domain Controller to be used during the attack must have its certificate and keys. This means the organization must have AD CS, PKI, CA, or something similar.

As mentioned by [ShutdownRepo](https://github.com/ShutdownRepo/pywhisker), Pre-reqs 1 and 2 must be met because the PKINIT features were introduced with Windows Server 2016. Pre-req 3 is necessary because the DC requires its own certificate and keys for the session key exchange during the AS_REQ <-> AS_REP transaction. If Pre-req 3 is not met, a `KRB-ERROR (16): KDC_ERR_PADATA_TYPE_NOSUPP` will be raised.

---
---
